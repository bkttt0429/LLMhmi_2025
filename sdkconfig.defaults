# ============================================
# ESP32-S3 CAM N16R8 優化配置
# Flash: 16MB | PSRAM: 8MB OPI
# ============================================

# --- PSRAM 配置（關鍵優化） ---
CONFIG_ESP32S3_SPIRAM_SUPPORT=y
CONFIG_SPIRAM=y
CONFIG_SPIRAM_MODE_OCT=y
CONFIG_SPIRAM_SPEED_80M=y               # ⭐ 80MHz (Stable)
CONFIG_SPIRAM_FETCH_INSTRUCTIONS=y      # ⭐ 指令快取加速
CONFIG_SPIRAM_RODATA=y                  # ⭐ 唯讀資料放 PSRAM
CONFIG_SPIRAM_USE_MALLOC=y              # 允許 malloc 使用 PSRAM
CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL=4096 # 小於 4KB 的分配用 Internal RAM

# --- 記憶體配置 ---
CONFIG_ESP_SYSTEM_ALLOW_RTC_FAST_MEM_AS_HEAP=y
CONFIG_ESP_SYSTEM_EVENT_TASK_STACK_SIZE=4096

# --- Wi-Fi 優化 ---
CONFIG_ESP32_WIFI_DYNAMIC_RX_BUFFER_NUM=16  # 增加接收緩衝
CONFIG_ESP32_WIFI_DYNAMIC_TX_BUFFER_NUM=16  # 增加傳送緩衝
CONFIG_ESP32_WIFI_STATIC_RX_BUFFER_NUM=8
CONFIG_ESP32_WIFI_STATIC_TX_BUFFER_NUM=0
CONFIG_ESP32_WIFI_AMPDU_TX_ENABLED=y        # 啟用聚合傳輸
CONFIG_ESP32_WIFI_AMPDU_RX_ENABLED=y
CONFIG_ESP32_WIFI_RX_BA_WIN=16              # 增加接收窗口

# --- TCP/IP 優化（串流關鍵） ---
CONFIG_LWIP_TCP_SND_BUF_DEFAULT=32768       # TCP 傳送緩衝 32KB
CONFIG_LWIP_TCP_WND_DEFAULT=32768           # TCP 接收窗口 32KB
CONFIG_LWIP_TCP_RECVMBOX_SIZE=16
CONFIG_LWIP_UDP_RECVMBOX_SIZE=16
CONFIG_LWIP_TCPIP_RECVMBOX_SIZE=64          # 增加 TCP/IP 任務郵箱

# --- HTTP Server 優化 ---
CONFIG_HTTPD_MAX_REQ_HDR_LEN=1024
CONFIG_HTTPD_MAX_URI_LEN=512

# --- FreeRTOS 優化 ---
CONFIG_FREERTOS_HZ=1000                     # Tick Rate 1000Hz
CONFIG_FREERTOS_UNICORE=n                   # 雙核心模式
CONFIG_ESP_SYSTEM_EVENT_TASK_STACK_SIZE=4096

# --- Camera 特定配置 ---
CONFIG_CAMERA_CORE0=n                       # 相機任務在 Core 1
CONFIG_CAMERA_CORE1=y
CONFIG_CAMERA_DMA_BUFFER_SIZE_MAX=32768     # DMA 緩衝最大值

# --- Log 等級（Production 可調整為 INFO） ---
CONFIG_LOG_DEFAULT_LEVEL_INFO=y
CONFIG_LOG_MAXIMUM_LEVEL_VERBOSE=y

# --- Watchdog 配置 ---
CONFIG_ESP_TASK_WDT=y
CONFIG_ESP_TASK_WDT_TIMEOUT_S=10            # 看門狗 10 秒

# --- Flash 配置（16MB） ---
CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y
CONFIG_ESPTOOLPY_FLASHSIZE="16MB"
# CONFIG_PARTITION_TABLE_CUSTOM=y
# CONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions.csv"

# --- 編譯器優化 ---
CONFIG_COMPILER_OPTIMIZATION_PERF=y         # 效能優化
CONFIG_COMPILER_OPTIMIZATION_ASSERTIONS_DISABLE=y # Release 模式

# --- Power Management ---
CONFIG_PM_ENABLE=n                          # 禁用省電模式（最大效能）

# --- 其他優化 ---
CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240=y       # CPU 240MHz
CONFIG_ESP32S3_DATA_CACHE_LINE_64B=y        # 64B Cache Line