<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EEZYbotARM 3D Simulator - WebGL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* UI Overlay */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(15, 15, 35, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            min-width: 280px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
        }

        .info-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #00d4ff;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-label {
            color: #aaa;
            font-size: 13px;
        }

        .status-value {
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            font-family: 'Consolas', monospace;
        }

        .gamepad-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 15, 35, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            min-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
        }

        .gamepad-connected {
            color: #00ff88;
            font-weight: bold;
        }

        .gamepad-disconnected {
            color: #ff4444;
            font-weight: bold;
        }

        .axis-display {
            margin-top: 15px;
        }

        .axis-bar {
            margin-bottom: 12px;
        }

        .axis-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .axis-bar-bg {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .axis-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            border-radius: 4px;
            transition: width 0.1s ease;
        }

        .controls-help {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 15, 35, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            max-width: 350px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
        }

        .controls-help h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #00d4ff;
        }

        .controls-help ul {
            list-style: none;
            font-size: 13px;
            line-height: 1.8;
        }

        .controls-help li {
            color: #ccc;
            margin-bottom: 5px;
        }

        .controls-help li strong {
            color: #00ff88;
            font-weight: 600;
        }

        /* Loading Screen */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            color: #00d4ff;
        }

        .model-warning {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 8px;
            max-width: 500px;
            text-align: center;
        }

        .model-warning h3 {
            color: #ff4444;
            margin-bottom: 10px;
        }

        .model-warning p {
            color: #ffaaaa;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div id="canvas-container"></div>

    <div class="ui-overlay">
        <!-- Info Panel -->
        <div class="info-panel">
            <h2>ğŸ¤– æ©Ÿå™¨æ‰‹è‡‚ç‹€æ…‹</h2>
            <div class="status-item">
                <span class="status-label">åº•åº§æ—‹è½‰ (Base)</span>
                <span class="status-value" id="base-angle">0Â°</span>
            </div>
            <div class="status-item">
                <span class="status-label">å¤§è‡‚ (Shoulder)</span>
                <span class="status-value" id="shoulder-angle">0Â°</span>
            </div>
            <div class="status-item">
                <span class="status-label">å°è‡‚ (Elbow)</span>
                <span class="status-value" id="elbow-angle">0Â°</span>
            </div>
        </div>

        <!-- Gamepad Status -->
        <div class="gamepad-status">
            <h2>ğŸ® Xbox æ§åˆ¶å™¨</h2>
            <div class="status-item">
                <span class="status-label">ç‹€æ…‹</span>
                <span class="status-value" id="gamepad-status">æœªé€£æ¥</span>
            </div>
            <div class="axis-display" id="axis-display" style="display: none;">
                <div class="axis-bar">
                    <div class="axis-label">å·¦æ–æ¡¿ X (åº•åº§æ—‹è½‰)</div>
                    <div class="axis-bar-bg">
                        <div class="axis-bar-fill" id="axis-0" style="width: 50%;"></div>
                    </div>
                </div>
                <div class="axis-bar">
                    <div class="axis-label">å·¦æ–æ¡¿ Y (å¤§è‡‚)</div>
                    <div class="axis-bar-bg">
                        <div class="axis-bar-fill" id="axis-1" style="width: 50%;"></div>
                    </div>
                </div>
                <div class="axis-bar">
                    <div class="axis-label">å³æ–æ¡¿ Y (å°è‡‚)</div>
                    <div class="axis-bar-bg">
                        <div class="axis-bar-fill" id="axis-3" style="width: 50%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Help -->
        <div class="controls-help">
            <h3>ğŸ“‹ æ“ä½œèªªæ˜</h3>
            <ul>
                <li><strong>æ»‘é¼ æ‹–æ›³ï¼š</strong>æ—‹è½‰è¦–è§’</li>
                <li><strong>æ»‘é¼ æ»¾è¼ªï¼š</strong>ç¸®æ”¾</li>
                <li><strong>æ»‘é¼ å³éµï¼š</strong>å¹³ç§»è¦–è§’</li>
                <li><strong>å·¦æ–æ¡¿ â†â†’ï¼š</strong>åº•åº§æ—‹è½‰</li>
                <li><strong>å·¦æ–æ¡¿ â†‘â†“ï¼š</strong>å¤§è‡‚ä¸Šä¸‹</li>
                <li><strong>å³æ–æ¡¿ â†‘â†“ï¼š</strong>å°è‡‚ä¼¸ç¸®</li>
            </ul>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="spinner"></div>
        <div class="loading-text">è¼‰å…¥ä¸­...</div>
        <div class="model-warning">
            <h3>âš ï¸ æ¨¡å‹æª”æ¡ˆéœ€æ±‚</h3>
            <p>è«‹å°‡æ‚¨çš„ <strong>eezybotarm.glb</strong> æ¨¡å‹æª”æ¡ˆæ”¾åœ¨èˆ‡æ­¤ HTML æª”æ¡ˆç›¸åŒçš„ç›®éŒ„ä¸‹ã€‚</p>
            <p style="margin-top: 10px;">æ¨¡å‹æ‡‰åŒ…å«ä»¥ä¸‹éƒ¨ä»¶åç¨±ï¼š<br>
                â€¢ Base æˆ– Waist (åº•åº§)<br>
                â€¢ Shoulder æˆ– MainArm (å¤§è‡‚)<br>
                â€¢ Elbow æˆ– Forearm (å°è‡‚)</p>
        </div>
    </div>

    <!-- Three.js via CDN (ESM) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        // ==================== Scene Setup ====================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        scene.fog = new THREE.Fog(0x1a1a2e, 50, 100);

        // Camera
        const camera = new THREE.PerspectiveCamera(
            50,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(5, 4, 8);

        // Renderer
        const renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        renderer.outputColorSpace = THREE.SRGBColorSpace;

        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 3;
        controls.maxDistance = 20;
        controls.maxPolarAngle = Math.PI / 2;

        // ==================== Lighting ====================
        // Ambient Light
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        // Main Directional Light (with shadow)
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
        mainLight.position.set(10, 15, 10);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        mainLight.shadow.camera.near = 0.5;
        mainLight.shadow.camera.far = 50;
        mainLight.shadow.camera.left = -10;
        mainLight.shadow.camera.right = 10;
        mainLight.shadow.camera.top = 10;
        mainLight.shadow.camera.bottom = -10;
        scene.add(mainLight);

        // Fill Light
        const fillLight = new THREE.DirectionalLight(0x4488ff, 0.4);
        fillLight.position.set(-5, 5, -5);
        scene.add(fillLight);

        // Rim Light
        const rimLight = new THREE.PointLight(0xff8844, 0.8, 30);
        rimLight.position.set(0, 8, -8);
        scene.add(rimLight);

        // ==================== Ground & Grid ====================
        // Grid Helper
        const gridHelper = new THREE.GridHelper(20, 20, 0x00d4ff, 0x444444);
        gridHelper.material.opacity = 0.3;
        gridHelper.material.transparent = true;
        scene.add(gridHelper);

        // Ground Plane (receives shadow)
        const groundGeometry = new THREE.PlaneGeometry(20, 20);
        const groundMaterial = new THREE.ShadowMaterial({ opacity: 0.3 });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // ==================== Robot Arm Model ====================
        let robotModel = null;
        let basePart = null;
        let shoulderPart = null;
        let elbowPart = null;

        // Target angles (controlled by gamepad)
        let targetBaseAngle = 0;
        let targetShoulderAngle = 0;
        let targetElbowAngle = 0;

        // Current angles (smoothly interpolated)
        let currentBaseAngle = 0;
        let currentShoulderAngle = 0;
        let currentElbowAngle = 0;

        // Control sensitivity
        const controlSpeed = 0.03;
        const smoothFactor = 0.1;

        // GLTF Loader
        const gltfLoader = new GLTFLoader();

        // âš ï¸ IMPORTANT: Replace 'eezybotarm.glb' with your actual model file path
        const modelPath = './eezybotarm.glb';

        gltfLoader.load(
            modelPath,
            (gltf) => {
                robotModel = gltf.scene;

                // Enable shadows for all meshes
                robotModel.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;

                        // Enhance materials for PBR
                        if (child.material) {
                            child.material.metalness = 0.4;
                            child.material.roughness = 0.6;
                        }
                    }
                });

                // âš ï¸ CRITICAL: Find named parts in the model
                // Adjust these names to match your actual model structure
                robotModel.traverse((child) => {
                    const name = child.name.toLowerCase();

                    // Base / Waist detection
                    if (!basePart && (name.includes('base') || name.includes('waist'))) {
                        basePart = child;
                        console.log('âœ… Found Base:', child.name);
                    }

                    // Shoulder / MainArm detection
                    if (!shoulderPart && (name.includes('shoulder') || name.includes('mainarm') || name.includes('main_arm'))) {
                        shoulderPart = child;
                        console.log('âœ… Found Shoulder:', child.name);
                    }

                    // Elbow / Forearm detection
                    if (!elbowPart && (name.includes('elbow') || name.includes('forearm') || name.includes('fore_arm'))) {
                        elbowPart = child;
                        console.log('âœ… Found Elbow:', child.name);
                    }
                });

                // Warning if parts not found
                if (!basePart) console.warn('âš ï¸ Base part not found! Check model naming.');
                if (!shoulderPart) console.warn('âš ï¸ Shoulder part not found! Check model naming.');
                if (!elbowPart) console.warn('âš ï¸ Elbow part not found! Check model naming.');

                scene.add(robotModel);
                console.log('âœ… Robot model loaded successfully');

                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 500);
            },
            (progress) => {
                const percent = (progress.loaded / progress.total * 100).toFixed(0);
                document.querySelector('.loading-text').textContent = `è¼‰å…¥ä¸­... ${percent}%`;
            },
            (error) => {
                console.error('âŒ Model loading failed:', error);
                document.querySelector('.loading-text').textContent = 'æ¨¡å‹è¼‰å…¥å¤±æ•—';
                document.querySelector('.loading-text').style.color = '#ff4444';
                document.querySelector('.model-warning h3').textContent = 'âŒ è¼‰å…¥å¤±æ•—';
                document.querySelector('.model-warning p').innerHTML =
                    `è«‹ç¢ºèª <strong>${modelPath}</strong> æª”æ¡ˆå­˜åœ¨ä¸”è·¯å¾‘æ­£ç¢ºã€‚<br>éŒ¯èª¤è¨Šæ¯: ${error.message}`;
            }
        );

        // Create a placeholder/demo robot if model fails to load
        function createPlaceholderRobot() {
            const placeholderGroup = new THREE.Group();

            // Base
            const baseGeo = new THREE.CylinderGeometry(0.8, 1, 0.3, 16);
            const baseMat = new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.6, roughness: 0.4 });
            basePart = new THREE.Mesh(baseGeo, baseMat);
            basePart.castShadow = true;
            basePart.receiveShadow = true;
            basePart.position.y = 0.15;
            placeholderGroup.add(basePart);

            // Shoulder (arm segment 1)
            const shoulderGeo = new THREE.BoxGeometry(0.4, 2, 0.4);
            const shoulderMat = new THREE.MeshStandardMaterial({ color: 0xff6600, metalness: 0.5, roughness: 0.5 });
            shoulderPart = new THREE.Mesh(shoulderGeo, shoulderMat);
            shoulderPart.castShadow = true;
            shoulderPart.position.set(0, 1.3, 0);
            basePart.add(shoulderPart);

            // Elbow (arm segment 2)
            const elbowGeo = new THREE.BoxGeometry(0.3, 1.5, 0.3);
            const elbowMat = new THREE.MeshStandardMaterial({ color: 0x00aaff, metalness: 0.5, roughness: 0.5 });
            elbowPart = new THREE.Mesh(elbowGeo, elbowMat);
            elbowPart.castShadow = true;
            elbowPart.position.set(0, 1.5, 0);
            shoulderPart.add(elbowPart);

            scene.add(placeholderGroup);
            robotModel = placeholderGroup;

            console.log('âœ… Placeholder robot created');
        }

        // Create placeholder after 3 seconds if model hasn't loaded
        setTimeout(() => {
            if (!robotModel) {
                createPlaceholderRobot();
                document.getElementById('loading-screen').classList.add('hidden');
                console.log('âš ï¸ Using placeholder robot');
            }
        }, 3000);

        // ==================== Gamepad Integration ====================
        let gamepadConnected = false;
        let gamepadIndex = null;

        window.addEventListener('gamepadconnected', (e) => {
            gamepadConnected = true;
            gamepadIndex = e.gamepad.index;
            console.log('ğŸ® Gamepad connected:', e.gamepad.id);
            updateGamepadUI(true);
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            gamepadConnected = false;
            gamepadIndex = null;
            console.log('ğŸ® Gamepad disconnected');
            updateGamepadUI(false);
        });

        function updateGamepadUI(connected) {
            const statusElement = document.getElementById('gamepad-status');
            const axisDisplay = document.getElementById('axis-display');

            if (connected) {
                statusElement.textContent = 'å·²é€£æ¥';
                statusElement.className = 'status-value gamepad-connected';
                axisDisplay.style.display = 'block';
            } else {
                statusElement.textContent = 'æœªé€£æ¥';
                statusElement.className = 'status-value gamepad-disconnected';
                axisDisplay.style.display = 'none';
            }
        }

        function updateGamepadInput() {
            if (!gamepadConnected) return;

            const gamepads = navigator.getGamepads();
            if (!gamepads[gamepadIndex]) return;

            const gamepad = gamepads[gamepadIndex];

            // Xbox controller axes mapping:
            // axes[0] = Left stick X (left/right)
            // axes[1] = Left stick Y (up/down)
            // axes[2] = Right stick X
            // axes[3] = Right stick Y (up/down)

            const leftX = gamepad.axes[0] || 0;  // Base rotation
            const leftY = gamepad.axes[1] || 0;  // Shoulder
            const rightY = gamepad.axes[3] || 0; // Elbow

            // Deadzone filtering
            const deadzone = 0.15;
            const filterDeadzone = (value) => Math.abs(value) < deadzone ? 0 : value;

            const filteredLeftX = filterDeadzone(leftX);
            const filteredLeftY = filterDeadzone(leftY);
            const filteredRightY = filterDeadzone(rightY);

            // Incremental control (not direct mapping)
            targetBaseAngle += filteredLeftX * controlSpeed;
            targetShoulderAngle += filteredLeftY * controlSpeed;
            targetElbowAngle += filteredRightY * controlSpeed;

            // Clamp angles to reasonable limits
            targetBaseAngle = THREE.MathUtils.clamp(targetBaseAngle, -Math.PI, Math.PI);
            targetShoulderAngle = THREE.MathUtils.clamp(targetShoulderAngle, -Math.PI / 2, Math.PI / 2);
            targetElbowAngle = THREE.MathUtils.clamp(targetElbowAngle, -Math.PI / 2, Math.PI / 2);

            // Update UI
            updateAxisBar('axis-0', filteredLeftX);
            updateAxisBar('axis-1', filteredLeftY);
            updateAxisBar('axis-3', filteredRightY);
        }

        function updateAxisBar(id, value) {
            const bar = document.getElementById(id);
            if (bar) {
                const width = ((value + 1) / 2) * 100; // Convert -1~1 to 0~100%
                bar.style.width = width + '%';
            }
        }

        // ==================== Animation & Control ====================
        function updateRobotAngles() {
            // Smooth interpolation (Lerp) for realistic movement
            currentBaseAngle = THREE.MathUtils.lerp(currentBaseAngle, targetBaseAngle, smoothFactor);
            currentShoulderAngle = THREE.MathUtils.lerp(currentShoulderAngle, targetShoulderAngle, smoothFactor);
            currentElbowAngle = THREE.MathUtils.lerp(currentElbowAngle, targetElbowAngle, smoothFactor);

            // Apply rotations to robot parts
            if (basePart) {
                basePart.rotation.y = currentBaseAngle;
            }
            if (shoulderPart) {
                shoulderPart.rotation.x = currentShoulderAngle;
            }
            if (elbowPart) {
                elbowPart.rotation.x = currentElbowAngle;
            }

            // Update UI display
            document.getElementById('base-angle').textContent =
                (currentBaseAngle * 180 / Math.PI).toFixed(1) + 'Â°';
            document.getElementById('shoulder-angle').textContent =
                (currentShoulderAngle * 180 / Math.PI).toFixed(1) + 'Â°';
            document.getElementById('elbow-angle').textContent =
                (currentElbowAngle * 180 / Math.PI).toFixed(1) + 'Â°';
        }

        // ==================== Animation Loop ====================
        function animate() {
            requestAnimationFrame(animate);

            // Update gamepad input
            updateGamepadInput();

            // Update robot angles with smooth interpolation
            updateRobotAngles();

            // Update controls
            controls.update();

            // Render scene
            renderer.render(scene, camera);
        }

        // ==================== Responsive Resize ====================
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ==================== Start Animation ====================
        animate();
        console.log('ğŸš€ Simulator started');
        console.log('ğŸ’¡ Connect your Xbox controller and use the joysticks to control the robot arm!');
    </script>
</body>

</html>