<!DOCTYPE html>
<!-- VERSION: 2025-12-07-OPTIMIZED-v1 - MODULARIZED -->
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Force browser to reload JS/CSS (no cache) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TACTICAL COMMAND v15.1 [DUAL-LINK]</title>

    <!-- Local Tailwind CSS (compiled) -->
    <link rel="stylesheet" href="/static/css/output.css?v=15.1">
    <!-- Custom Cyber Styles -->
    <link rel="stylesheet" href="/static/css/custom.css?v=15.1">

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <!-- Three.js Import Maps -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>

<body
    class="h-screen flex flex-col p-2 sm:p-4 gap-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">

    <header
        class="flex flex-col sm:flex-row justify-between items-start sm:items-end border-b border-green-500/30 pb-2 shrink-0 gap-2">
        <div>
            <h1
                class="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-widest text-green-400 drop-shadow-[0_0_5px_rgba(0,255,157,0.8)]">
                SHIM INTERFACE <span class="text-xs sm:text-sm text-gray-500">v15.1 MODULAR</span></h1>
            <div class="text-[10px] sm:text-xs text-gray-400 tracking-wider flex items-center gap-4 flex-wrap">
                <div class="flex items-center gap-1">
                    <span>CONTROL(UDP):</span>
                    <span id="car-ip-display" class="text-yellow-500 font-bold">--.--.--.--</span>
                </div>
                <div class="flex items-center gap-1">
                    <span>VIDEO:</span>
                    <span id="cam-ip-display" class="text-blue-400 font-bold">--.--.--.--</span>
                </div>
                <span id="gamepad-status" class="opacity-30 transition-opacity flex items-center gap-1">ðŸŽ®
                    GAMEPAD</span>
            </div>
        </div>
        <div id="clock" class="text-lg sm:text-2xl text-green-600">00:00:00</div>
    </header>

    <!-- Main View (Dashboard) -->
    <div id="main-view" class="view-grid dashboard-grid pb-20 overflow-hidden">

        <!-- Left Column (Video + Command) -->
        <div class="col-left">
            <!-- Quadrant 1: Video Feed + HUD -->
            <div class="grid-video-hud cyber-border flex flex-col gap-2">
                <div class="flex justify-between px-2 text-[10px] sm:text-xs text-gray-500 font-bold flex-wrap gap-2">
                    <div class="flex gap-2 items-center text-green-600">
                        SYSTEM STATUS: <span class="text-green-400">OPERATIONAL</span>
                    </div>
                    <span>AI: <span id="ai-status" class="text-gray-500">STANDBY</span></span>
                    <span>FEED: <span class="text-green-400 animate-pulse">LIVE</span></span>
                </div>

                <div
                    class="flex-1 bg-black relative overflow-hidden flex items-center justify-center border border-gray-800 group">
                    <div class="scan-line"></div>

                    <!-- AI DET Toggle Button (Top-Right) -->
                    <button id="btn-ai-det" onclick="toggleAIDetection()"
                        class="absolute top-2 right-2 z-30 btn-cy px-3 py-1 text-[10px] font-bold rounded border border-green-500 bg-black/60 backdrop-blur-sm hover:bg-green-500/20 transition-all">
                        <span id="ai-det-text">AI DET</span>
                    </button>

                    <!-- Video Stream Image -->
                    <img id="video-stream" src="/video_feed" alt="Live video feed from ESP32-S3 camera"
                        class="w-full h-full object-contain">

                    <div id="no-sig"
                        class="hidden absolute inset-0 flex-col items-center justify-center bg-black/80 z-20">
                        <div
                            class="text-2xl sm:text-4xl text-red-500 font-bold border-4 border-red-500 p-4 sm:p-6 animate-pulse">
                            NO SIGNAL</div>
                        <div class="text-red-400 mt-2 text-xs sm:text-sm">CHECK ESP32-S3 (CAMERA)</div>
                        <div class="text-gray-500 mt-2 text-[10px]">Retrying connection...</div>
                    </div>

                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30">
                        <div class="w-[40px] h-[40px] border border-green-500 rounded-full absolute"></div>
                        <div class="w-[200px] h-[1px] bg-green-500"></div>
                        <div class="h-[200px] w-[1px] bg-green-500 absolute"></div>
                    </div>
                </div>

                <div id="log-box"
                    class="h-24 sm:h-32 bg-black border-t border-gray-700 p-2 font-mono text-[10px] sm:text-xs overflow-y-auto text-gray-400 leading-tight">
                    <div class="text-green-700">> Initializing Modular Interface...</div>
                </div>
            </div>


        </div>

        <!-- Right Column (Arm + Manual) -->
        <div class="col-right">
            <!-- Quadrant 2: Arm HMI (3D Simulation) -->
            <div class="grid-arm-hmi cyber-border flex flex-col p-2">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">3D SIMULATION</div>

                <div id="canvas-3d-container"
                    class="relative w-full max-w-[320px] aspect-square rounded border border-green-900 bg-[#1a1a1a] overflow-hidden mx-auto"
                    style="min-width: 250px; min-height: 250px;">
                    <!-- Three.js canvas will be appended here -->
                </div>
            </div>

            <!-- Quadrant 4: CONTROL + MANUAL (Right-Bottom) -->
            <div class="grid-manual cyber-border flex flex-col gap-2 p-3">
                <div class="label-corner">CONTROL</div>

                <!-- Speed Limiter (Horizontal Layout) -->
                <div class="control-row">
                    <span class="control-label">SPEED</span>
                    <input type="range" min="0" max="100" value="100" step="5" class="speed-slider-compact"
                        id="speed-limit-slider" title="Control speed limit" aria-label="Speed limit slider">
                    <span class="control-value" id="speed-limit-value">100%</span>
                </div>

                <!-- Motor Lock -->
                <div class="control-row">
                    <button id="btn-motor-lock" onclick="toggleMotorLock()"
                        class="btn-compact w-full text-green-400 border-green-500">
                        MOTORS: <span class="animate-pulse">ON</span>
                    </button>
                </div>

                <div class="border-t border-gray-700 my-1"></div>

                <!-- WASD Compact Keyboard -->
                <div class="wasd-container-compact">
                    <div class="wasd-row">
                        <div style="width: 40px"></div>
                        <button class="wasd-key" onmousedown="sendCmd('F')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('F')" ontouchend="sendCmd('S')" id="btn-w">W</button>
                        <div style="width: 40px"></div>
                    </div>
                    <div class="wasd-row">
                        <button class="wasd-key" onmousedown="sendCmd('L')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('L')" ontouchend="sendCmd('S')" id="btn-a">A</button>
                        <button class="wasd-key" onmousedown="sendCmd('S')" ontouchstart="sendCmd('S')"
                            id="btn-s">S</button>
                        <button class="wasd-key" onmousedown="sendCmd('R')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('R')" ontouchend="sendCmd('S')" id="btn-d">D</button>
                    </div>
                    <div class="wasd-row">
                        <div style="width: 40px"></div>
                        <button class="wasd-key" onmousedown="sendCmd('B')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('B')" ontouchend="sendCmd('S')" id="btn-x">X</button>
                        <div style="width: 40px"></div>
                    </div>
                </div>

                <!-- Joystick Visualization (Compact) -->
                <div class="flex justify-center gap-3 mt-2">
                    <div class="flex flex-col items-center gap-1">
                        <div class="text-[8px] text-gray-400 uppercase">Left</div>
                        <div class="xbox-stick-mini" id="hud-stick-left"></div>
                        <div class="hud-coords" id="stick-coords-left">0.00, 0.00</div>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <div class="text-[8px] text-gray-400 uppercase">Right</div>
                        <div class="xbox-stick-mini" id="hud-stick-right"></div>
                        <div class="hud-coords" id="stick-coords-right">0.00, 0.00</div>
                    </div>
                </div>

                <!-- PWM Display (Compact) -->
                <div class="flex gap-2 text-[9px] font-mono justify-center">
                    <div class="bg-black/60 border border-green-900/50 rounded px-2 py-1">
                        <span class="text-gray-500">L:</span>
                        <span class="text-green-400 font-bold" id="pwm-left">0</span>
                    </div>
                    <div class="bg-black/60 border border-green-900/50 rounded px-2 py-1">
                        <span class="text-gray-500">R:</span>
                        <span class="text-green-400 font-bold" id="pwm-right">0</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Settings View -->
    <div id="settings-view" class="flex-1 overflow-auto p-2 sm:p-4 pb-20 view-hidden">
        <div class="max-w-3xl mx-auto space-y-4">
            <!-- Connection Settings -->
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 flex items-center gap-2 text-sm sm:text-base">
                    <span class="text-xl">ðŸ“¡</span> DUAL-LINK CONNECTION
                </div>
                <div class="space-y-4">
                    <div class="p-3 border border-green-900/50 rounded bg-green-900/10">
                        <label class="block text-xs text-green-400 mb-1 font-bold">ðŸš— Car Control IP (ESP12F)</label>
                        <input id="settings-car-ip" type="text"
                            class="w-full bg-black text-green-400 border border-green-900 px-2 py-2 rounded focus:outline-none focus:border-green-500 text-sm font-mono"
                            placeholder="192.168.x.x">
                    </div>
                    <div class="p-3 border border-blue-900/50 rounded bg-blue-900/10">
                        <label class="block text-xs text-blue-400 mb-1 font-bold">ðŸ“¹ Camera Stream IP (ESP32-S3)</label>
                        <input id="settings-cam-ip" type="text"
                            class="w-full bg-black text-blue-400 border border-blue-900 px-2 py-2 rounded focus:outline-none focus:border-blue-500 text-sm font-mono"
                            placeholder="192.168.x.x">
                    </div>
                    <button onclick="applySettings()" class="btn-cy w-full py-3 rounded text-sm font-bold">APPLY DUAL IP
                        SETTINGS</button>
                </div>
            </div>

            <!-- System Tools -->
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">SYSTEM TOOLS</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col gap-2">
                        <button onclick="toggleAI()" id="ai-toggle-btn"
                            class="btn-cy py-2 rounded text-xs sm:text-sm">ACTIVATE AI HUD</button>
                        <button onclick="exportLogs()" class="btn-cy py-2 rounded text-xs sm:text-sm">EXPORT SYSTEM
                            LOGS</button>
                        <button onclick="showNetInfo()"
                            class="btn-cy py-2 rounded text-xs sm:text-sm text-blue-300 border-blue-500">SHOW NET
                            INFO</button>
                    </div>
                    <!-- AI Model Selector -->
                    <div class="flex flex-col gap-2 p-2 border border-green-900/30 rounded">
                        <label class="text-xs text-green-400 font-bold">ðŸ§  AI Model Selection</label>
                        <div class="flex gap-2">
                            <select id="model-selector" title="Select AI model"
                                class="bg-black text-green-400 border border-green-800 rounded px-2 py-1 text-xs flex-1">
                                <option value="yolov13l.pt" selected>YOLOv13-Large (Default)</option>
                            </select>
                            <button onclick="applyModel()" class="btn-cy px-4 text-xs rounded font-bold">LOAD</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Config -->
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">CAMERA CONFIGURATION</div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-xs">
                    <div class="flex flex-col gap-1">
                        <label class="text-gray-400">Resolution</label>
                        <select id="cfg-framesize" onchange="updateCameraSetting('framesize', this.value)"
                            class="bg-black border border-green-900 text-green-400 p-1 rounded">
                            <option value="11">VGA (640x480)</option>
                            <option value="9">CIF (400x296)</option>
                            <option value="8">QVGA (320x240)</option>
                        </select>
                    </div>
                    <!-- Other Camera Controls here (Generated dynamically or reused) -->
                    <div
                        class="col-span-full grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 border-t border-gray-800 pt-2">
                        <button id="btn-awb" onclick="toggleCamBool('awb')"
                            class="btn-cy py-1 text-[10px] rounded">AWB</button>
                        <button id="btn-aec" onclick="toggleCamBool('aec')"
                            class="btn-cy py-1 text-[10px] rounded">AEC</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Robot View Container Removed -->

    <!-- Navigation -->
    <div class="nav-bar">
        <button onclick="switchView('main')" class="nav-btn active" id="nav-main">
            <span>ðŸŽ®</span> <span class="hidden sm:inline">COMMAND</span>
        </button>
        <button onclick="switchView('settings')" class="nav-btn" id="nav-settings">
            <span>âš™</span> <span class="hidden sm:inline">SYSTEM</span>
        </button>
    </div>

    <script>
        // Clock
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);
    </script>

    <!-- Load Modular Scripts (Order matters) -->
    <script src="/static/js/ui.js?v=15.1"></script>
    <script src="/static/js/ai_controls.js?v=15.1"></script>
    <script src="/static/js/gamepad.js?v=15.1"></script>
    <!-- Three.js Module -->
    <script type="module" src="/static/js/robot_arm.js?v=15.1"></script>
    <script src="/static/js/main.js?v=15.1"></script>
</body>

</html>