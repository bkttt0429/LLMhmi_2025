# ESP32-S3 + ESP8266 + PC 客戶端整合設計（以 espressif/esp32-camera 為基礎）

本文件把既有的雙網卡（ESP32-S3 Station + ESP8266 Sensor + PC Client）架構，重新對照 **[espressif/esp32-camera](https://github.com/espressif/esp32-camera)** 的官方驅動與 `camera_web_server` 範例來編寫，方便直接套用官方程式碼並擴充控制與感測 API。

## 1. 元件與角色
- **ESP32-S3-CAM（Station 模式）**
  - 以 `esp32-camera` 的 `camera_web_server` 為基礎：提供 `/stream` MJPEG 串流與 `/` 控制介面。
  - 加入自訂路由：`/control?left=<val>&right=<val>` 馬達控制、`/dist` 回傳最新感測距離。
  - 監聽 UDP 4211：接收 ESP8266 感測數據，並緩存給 `/dist` 回應。
- **ESP8266 感測端（Station 模式）**
  - 讀取超聲波或其他傳感器，固定以 UDP 送往 ESP32-S3 IP 的 4211 端口。
- **PC Client（Python/Flask + Socket.IO）**
  - 直接抓取 `http://<ESP32_IP>/stream` 顯示影像。
  - 透過 HTTP 控制車體與取得 `/dist` 感測值；必要時透過 Serial 後備控制。

## 2. ESP32-S3 實作重點（對照 `camera_web_server`）
- **相機初始化**：
  - 使用 `camera_pins.h` 指定 S3-CAM 腳位，保留示例的 `esp_camera_init` 與 JPEG 硬體編碼設定。
  - 依 PSRAM 容量調整解析度 (`FRAMESIZE_SVGA`/`QVGA`) 與 `fb_count`，延續現有 `app_camera_init()` 的邏輯。
- **HTTP 服務**：
  - 沿用範例的 MJPEG handler (`/stream`)；加入 TCP keep-alive、send buffer 設定以保持串流順暢。
  - 新增 REST 路由：
    - `/control`：解析 `left/right` 參數後呼叫 `app_motor_set_power()`。
    - `/dist`：回傳最後一次 UDP 感測值或預設值（例如 `-1` 表示尚未收到）。
    - `/health`（可選）：呼叫 `app_camera_health_check()` 供 PC 偵測相機狀態。
- **UDP 感測整合**：
  - 維持 `app_udp_start()` 監聽 4211，將有效數值緩存在共享變數中，並在 `/dist` 與串流日誌中回報。
- **馬達控制**：
  - `app_motor_init()` 初始化 GPIO/PWM；`/control` 直接使用現有映射邏輯。

## 3. PC Client / Flask 對應調整
- **串流來源**：改讀 `http://<ESP32_IP>/stream`（與 `camera_web_server` 相同）。
- **控制與感測 API**：
  - 馬達：`/control?left=<val>&right=<val>`；建議在 UI 內提供範圍提示（-255~255）。
  - 距離：`/dist`，若回傳 `-1` 或 HTTP 5xx 則在 UI 顯示「感測未就緒」。
- **容錯**：
  - Flask 啟動時先以 `GET /health` 檢查相機與串流狀態；失敗則定期重試並在日誌提示使用者檢查 AP IP 或重啟。

## 4. 佈署與測試流程
1. **ESP32-S3**：
   - 將 `esp32-camera` 以 component 方式加入（或直接複製 `camera_web_server` 目錄做基礎）。
   - 設定 Wi-Fi Station SSID/Password，燒錄並在序列埠確認取得 IP。
2. **ESP8266**：
   - 同步使用相同 AP 設定，將 UDP 目標 IP 設為 ESP32-S3；測試以 `nc -u <ESP32_IP> 4211` 觀察是否收包。
3. **PC Client**：
   - 更新 `config.py` 的 `ESP32_HOST`；啟動 Flask 後以瀏覽器打開 `/`，應可看到 `/stream` 畫面與距離數據。

## 5. 後續可擴充項目
- 在 `camera_web_server` 的控制頁面加入馬達與感測資訊，使手動調校更直觀。
- 依硬體實際安裝調整 `set_vflip`/`set_hmirror` 及 `jpeg_quality`，透過 `/control` 或新建 `/sensor` 路由即時調整。
- 針對串流掉幀與網路品質，使用現有 `g_stats` 統計定期推送到 PC 日誌或 `/health` 回應。
