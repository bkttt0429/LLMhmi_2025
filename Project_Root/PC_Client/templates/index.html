<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL COMMAND v14.0 [MERGED]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        body {
            background-color: #050505;
            color: #00ff9d;
            font-family: 'Share Tech Mono', monospace;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* --- Cyberpunk Visuals --- */
        .cyber-border {
            border: 1px solid #333;
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.1);
            background: rgba(10, 20, 20, 0.85);
            backdrop-filter: blur(4px);
        }

        .scan-line {
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.3) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            position: absolute;
            z-index: 10;
        }

        /* --- Buttons --- */
        .btn-cy {
            border: 1px solid #00ff9d;
            color: #00ff9d;
            background: rgba(0, 20, 10, 0.6);
            transition: all 0.1s;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .btn-cy:hover { background: #00ff9d; color: #000; box-shadow: 0 0 15px #00ff9d; }
        .btn-cy:active { transform: scale(0.95); }
        .btn-active { background: #00ff9d; color: #000; box-shadow: 0 0 15px #00ff9d; }

        /* Nav Bar Styles */
        .nav-bar {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(10, 20, 20, 0.95);
            border: 1px solid #00ff9d;
            border-radius: 50px;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.3);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            max-width: 95vw;
        }

        .nav-btn {
            padding: 8px 12px;
            border: 1px solid #00ff9d;
            background: rgba(0, 20, 10, 0.6);
            color: #00ff9d;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        @media (min-width: 640px) {
            .nav-bar { gap: 10px; padding: 10px 20px; }
            .nav-btn { padding: 10px 20px; font-size: 0.9rem; gap: 8px; }
        }

        .nav-btn:hover { background: #00ff9d; color: #000; box-shadow: 0 0 15px #00ff9d; }
        .nav-btn.active { background: #00ff9d; color: #000; box-shadow: 0 0 20px #00ff9d; }
        
        /* Gamepad Indicator */
        .gamepad-icon { opacity: 0.3; transition: opacity 0.3s; }
        .gamepad-connected { opacity: 1; color: #00ff9d; text-shadow: 0 0 10px #00ff9d; }

        /* Xbox Visualizer */
        .xbox-card {
            background: radial-gradient(circle at 20% 20%, rgba(0,255,157,0.06), transparent 35%),
                        radial-gradient(circle at 80% 0%, rgba(0,255,255,0.06), transparent 30%),
                        rgba(5, 15, 10, 0.85);
            border: 1px solid rgba(0,255,157,0.2);
            box-shadow: 0 0 25px rgba(0,255,157,0.08);
        }
        .xbox-stick {
            width: 64px; height: 64px;
            border: 1px solid #0f766e;
            border-radius: 50%;
            background: radial-gradient(circle, #0b1f1a 0%, #04100c 65%);
            box-shadow: inset 0 0 12px rgba(0,255,157,0.35);
            transition: transform 0.1s ease-out;
        }
        .xbox-stick::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 14px; height: 14px;
            background: #00ff9d;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px rgba(0,255,157,0.6);
        }
        .xbox-pulse {
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.35; }
            50% { opacity: 1; }
            100% { opacity: 0.35; }
        }
    </style>
</head>
<body class="h-screen flex flex-col p-2 sm:p-4 gap-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">

    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-end border-b border-green-500/30 pb-2 shrink-0 gap-2">
        <div>
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-widest text-green-400 drop-shadow-[0_0_5px_rgba(0,255,157,0.8)]">SHIM INTERFACE <span class="text-xs sm:text-sm text-gray-500">v14.0 MERGED</span></h1>
            <div class="text-[10px] sm:text-xs text-gray-400 tracking-wider flex items-center gap-2">
                LINK: <span id="ws-status" class="text-red-500 font-bold">OFFLINE</span>
                <span id="gamepad-status" class="gamepad-icon ml-4 flex items-center gap-1">üéÆ GAMEPAD</span>
            </div>
        </div>
        <div id="clock" class="text-lg sm:text-2xl text-green-600">00:00:00</div>
    </header>

    <div id="main-view" class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 min-h-0 pb-20">
        
        <div class="lg:col-span-8 flex flex-col gap-2 relative cyber-border rounded p-1 min-h-[300px]">
            <div class="flex justify-between px-2 text-[10px] sm:text-xs text-gray-500 font-bold flex-wrap gap-2">
                <div class="flex gap-2 items-center">
                    <span class="hidden sm:inline">TARGET IP:</span>
                    <input type="text" id="ip-input" class="bg-black text-green-400 border border-green-900 px-1 w-24 sm:w-32 focus:outline-none focus:border-green-500" placeholder="Waiting...">
                    <button onclick="setManualIP()" class="text-[10px] border border-green-700 px-1 sm:px-2 hover:bg-green-900">SET</button>
                </div>
                <span>FEED: <span class="text-green-400 animate-pulse">LIVE</span></span>
            </div>
            
            <div class="flex-1 bg-black relative overflow-hidden flex items-center justify-center border border-gray-800 group">
                <div class="scan-line"></div>
                <img src="/video_feed" class="w-full h-full object-contain" onerror="this.style.display='none'; document.getElementById('no-sig').style.display='flex'">
                
                <div id="no-sig" class="hidden absolute inset-0 flex-col items-center justify-center bg-black/80 z-20">
                    <div class="text-2xl sm:text-4xl text-red-500 font-bold border-4 border-red-500 p-4 sm:p-6 animate-pulse">NO SIGNAL</div>
                    <div class="text-red-400 mt-2 text-xs sm:text-sm">CHECK CONNECTION OR SERIAL PORT</div>
                </div>
                
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30">
                    <div class="w-[40px] h-[40px] border border-green-500 rounded-full absolute"></div>
                    <div class="w-[200px] h-[1px] bg-green-500"></div>
                    <div class="h-[200px] w-[1px] bg-green-500 absolute"></div>
                </div>
            </div>

            <div id="log-box" class="h-24 sm:h-32 bg-black border-t border-gray-700 p-2 font-mono text-[10px] sm:text-xs overflow-y-auto text-gray-400 leading-tight">
                <div class="text-green-700">> Initializing Native WebSocket & Canvas...</div>
            </div>
        </div>

        <div class="lg:col-span-4 flex flex-col gap-4">
            
            <div class="cyber-border p-2 sm:p-4 flex flex-col items-center justify-center relative grow-0">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">SONAR ARRAY</div>
                
                <div class="relative w-32 h-32 sm:w-40 sm:h-40 lg:w-56 lg:h-56 rounded-full border border-green-900 bg-black/80 shadow-[inset_0_0_20px_rgba(0,50,0,0.5)]">
                     <canvas id="radar-canvas-main" class="absolute inset-0 w-full h-full rounded-full"></canvas>
                </div>
                
                <div id="dist-val" class="text-xl sm:text-2xl lg:text-3xl font-bold mt-2 text-green-400 drop-shadow-[0_0_5px_rgba(0,255,0,0.5)]">--.-- CM</div>
            </div>

            <div class="cyber-border p-3 sm:p-6 flex-1 flex flex-col justify-center gap-4 sm:gap-6 relative">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">MANUAL OVERRIDE</div>

                <div class="grid grid-cols-3 gap-2 sm:gap-3 w-full max-w-[180px] sm:max-w-[240px] mx-auto">
                    <div></div>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl" 
                            onmousedown="sendCmd('F')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('F')" ontouchend="sendCmd('S')" id="btn-w">W</button>
                    <div></div>
                    
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="sendCmd('L')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('L')" ontouchend="sendCmd('S')" id="btn-a">A</button>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="sendCmd('S')"
                            ontouchstart="sendCmd('S')" id="btn-s">S</button>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="sendCmd('R')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('R')" ontouchend="sendCmd('S')" id="btn-d">D</button>
                    
                    <div></div>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="sendCmd('B')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('B')" ontouchend="sendCmd('S')" id="btn-x">X</button>
                    <div></div>
                </div>

                <button class="btn-cy w-full py-2 sm:py-3 rounded tracking-widest text-xs sm:text-sm" onclick="toggleLight()">TOGGLE LIGHTS</button>
            </div>

            <div class="xbox-card rounded p-3 sm:p-4 flex flex-col gap-3 relative">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">XBOX Ë¶ñË¶∫Âåñ</div>
                <div class="flex items-center gap-4">
                    <div class="relative xbox-stick" id="xbox-stick"></div>
                    <div class="space-y-1 text-xs sm:text-sm text-gray-300">
                        <div class="flex items-center gap-2"><span class="text-green-400 font-mono">LS</span>ÔºöÂâçÈÄ≤/ÂæåÈÄÄ/ËΩâÂêë</div>
                        <div class="flex items-center gap-2"><span class="text-green-400 font-mono">LS Êåâ‰∏ã</span>ÔºöÁ∑äÊÄ•ÁÖûËªä</div>
                        <div class="flex items-center gap-2"><span class="text-green-400 font-mono">A</span>ÔºöËªäÁáà</div>
                        <div class="flex items-center gap-2"><span class="text-green-400 font-mono">X</span>ÔºöÁ´ãÂç≥ÂÅúÊ≠¢</div>
                        <div class="flex items-center gap-2"><span class="text-green-400 font-mono">Y</span>ÔºöAI Èñã/Èóú</div>
                    </div>
                </div>
                <div class="flex items-center justify-between text-[10px] sm:text-xs text-gray-400">
                    <div>LINKÔºö<span id="xbox-link" class="text-red-500 font-bold">OFFLINE</span></div>
                    <div>CMDÔºö<span id="xbox-cmd" class="text-yellow-400 font-mono">--</span></div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-[10px] sm:text-xs text-gray-300">
                    <div class="flex items-center gap-2"><span class="w-6 text-green-400 font-mono text-center">A</span><span id="xbox-a" class="text-gray-500">OFF</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 text-green-400 font-mono text-center">B</span><span id="xbox-b" class="text-gray-500">OFF</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 text-green-400 font-mono text-center">X</span><span id="xbox-x" class="text-gray-500">OFF</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 text-green-400 font-mono text-center">Y</span><span id="xbox-y" class="text-gray-500">OFF</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 text-green-400 font-mono text-center">LS</span><span id="xbox-ls" class="text-gray-500">OFF</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 text-green-400 font-mono text-center">D-PAD</span><span id="xbox-dpad" class="text-gray-500">‚Äî</span></div>
                </div>
                <div class="text-[10px] text-gray-500">Â∑¶ÊêñÊ°øÂÅèÁßªËàáÊåâ‰∏ãÁãÄÊÖã„ÄÅÊåâÈçµÂõûÈ•ãÊúÉÂç≥ÊôÇÈ°ØÁ§∫„ÄÇ</div>
            </div>

            <div class="cyber-border p-2 sm:p-3 text-[10px] sm:text-xs flex flex-col gap-1">
                <div class="flex justify-between">
                    <span class="text-gray-500">SERIAL PORT:</span>
                    <span id="port-val" class="text-yellow-500 font-bold truncate max-w-[120px]">SEARCHING...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">LINK STATUS:</span>
                    <span id="link-text" class="text-gray-500 font-bold">WAITING</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">AI STATUS:</span>
                    <span id="ai-status" class="text-gray-400 font-bold">STANDBY</span>
                </div>
                <button onclick="toggleAI()" id="ai-toggle-btn" class="btn-cy w-full py-2 mt-2 rounded text-[10px] sm:text-xs tracking-wider">
                    ACTIVATE AI
                </button>
            </div>

        </div>
    </div>

    <div id="sensors-view" class="flex-1 flex flex-col lg:flex-row gap-4 min-h-0 pb-20 overflow-auto" style="display:none;">
        <div class="flex-[2] flex flex-col gap-2 min-h-[400px]">
            <div class="cyber-border rounded p-4 flex-1 relative overflow-hidden bg-black">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">ULTRASONIC RADAR</div>
                
                <div class="absolute inset-0 flex items-center justify-center p-4">
                    <div class="w-full h-full max-w-[400px] max-h-[400px] lg:max-w-[500px] lg:max-h-[500px] relative">
                         <canvas id="radar-canvas-sensor" class="w-full h-full rounded-full bg-black/80 border border-green-900 shadow-[inset_0_0_40px_rgba(0,50,0,0.3)]"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="cyber-border rounded p-3 h-32 bg-black">
                <div class="text-[10px] text-gray-500 mb-1">DISTANCE HISTORY (THROTTLED)</div>
                <canvas id="distance-chart" class="w-full h-full"></canvas>
            </div>
        </div>

        <div class="flex-1 cyber-border rounded p-4 flex flex-col gap-3 min-w-[280px]">
            <div class="text-sm text-green-400 font-bold border-b border-green-900 pb-2">SENSOR TELEMETRY</div>
            
            <div class="cyber-border p-3 rounded bg-black/60">
                <div class="text-xs text-gray-400 mb-1">Current Distance</div>
                <div id="sensor-distance-large" class="text-4xl sm:text-5xl font-bold font-mono text-green-400">--.-- CM</div>
                <div class="mt-2 flex gap-2 text-xs">
                    <div class="flex-1 bg-gray-800 rounded p-1">
                        <div class="text-gray-500">MIN</div>
                        <div id="sensor-min" class="text-yellow-400 font-mono">‚àû</div>
                    </div>
                    <div class="flex-1 bg-gray-800 rounded p-1">
                        <div class="text-gray-500">MAX</div>
                        <div id="sensor-max" class="text-yellow-400 font-mono">0</div>
                    </div>
                    <div class="flex-1 bg-gray-800 rounded p-1">
                        <div class="text-gray-500">AVG</div>
                        <div id="sensor-avg" class="text-yellow-400 font-mono">0</div>
                    </div>
                </div>
            </div>

            <div class="cyber-border p-3 rounded bg-black/60">
                <div class="text-xs text-gray-400 mb-2">ALERT ZONES</div>
                <div class="space-y-2 text-xs">
                    <div class="flex items-center justify-between">
                        <span class="text-red-400">‚óè DANGER (&lt;20cm)</span>
                        <span id="zone-danger" class="text-gray-500">CLEAR</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-yellow-400">‚óè WARNING (20-50cm)</span>
                        <span id="zone-warning" class="text-gray-500">CLEAR</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-green-400">‚óè SAFE (&gt;50cm)</span>
                        <span id="zone-safe" class="text-green-500">OK</span>
                    </div>
                </div>
            </div>

             <div class="cyber-border p-3 rounded bg-black/60 mt-auto">
                <div class="text-xs text-gray-400 mb-2">SENSOR STATUS</div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>
                        <div class="text-gray-500">Sampling Rate</div>
                        <div class="text-green-400 font-mono">WS-STREAM</div>
                    </div>
                    <div>
                        <div class="text-gray-500">Data Points</div>
                        <div id="data-count" class="text-green-400 font-mono">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-view" class="flex-1 overflow-auto p-2 sm:p-4 pb-20" style="display:none;">
        <div class="max-w-3xl mx-auto space-y-4">
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 flex items-center gap-2 text-sm sm:text-base">
                    <span class="text-xl">‚öô</span> CONNECTION SETTINGS
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Target IP Address</label>
                        <input id="settings-ip" type="text" class="w-full bg-black text-green-400 border border-green-900 px-2 py-1 rounded focus:outline-none focus:border-green-500 text-sm" placeholder="192.168.x.x">
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label class="block text-xs text-gray-400">Serial COM Port</label>
                            <button onclick="fetchPorts()" class="text-[10px] border border-green-700 px-2 py-1 hover:bg-green-900 rounded">REFRESH</button>
                        </div>
                        <select id="port-select" class="w-full bg-black text-green-400 border border-green-900 px-2 py-1 rounded focus:outline-none focus:border-green-500 text-sm"></select>
                        <button onclick="setPreferredPort()" class="btn-cy w-full py-2 rounded text-sm mt-2">SET PORT</button>
                    </div>
                    <button onclick="applySettings()" class="btn-cy w-full py-2 rounded text-sm">APPLY SETTINGS</button>
                </div>
            </div>

            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">CONTROL SETTINGS</div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs sm:text-sm text-gray-300">Auto-Stop on Obstacle</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input id="auto-stop" type="checkbox" checked class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs sm:text-sm text-gray-300">Enable Collision Warning</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input id="collision-warn" type="checkbox" checked class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">SYSTEM INFORMATION</div>
                <div class="space-y-2 text-xs sm:text-sm font-mono">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Interface Version:</span>
                        <span class="text-green-400">v14.0 MERGED_WS</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Backend Status:</span>
                        <span class="text-green-400">ACTIVE</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Protocol:</span>
                        <span class="text-green-400">NATIVE WEBSOCKET</span>
                    </div>
                </div>
            </div>

            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60 border-orange-900">
                <div class="text-orange-400 font-bold mb-3 text-sm sm:text-base flex items-center gap-2">
                    <span class="text-xl">‚ö°</span> FIRMWARE FLASH
                </div>
                <div class="space-y-3">
                    <div class="text-xs text-gray-400">
                        Upload latest firmware to ESP32-S3 CAM. This will disconnect serial temporarily.
                    </div>
                    
                    <div id="flash-progress-container" class="hidden">
                        <div class="w-full bg-gray-800 rounded-full h-4 mb-2 overflow-hidden">
                            <div id="flash-progress-bar" class="bg-orange-500 h-4 rounded-full transition-all duration-300 flex items-center justify-center text-[10px] font-bold" style="width: 0%">
                                <span id="flash-progress-text">0%</span>
                            </div>
                        </div>
                        <div id="flash-status-text" class="text-xs text-orange-400 text-center"></div>
                    </div>
                    
                    <button id="flash-btn" onclick="startFlashing()" class="btn-cy w-full py-3 rounded text-sm font-bold bg-orange-900/30 border-orange-500 hover:bg-orange-500">
                        üî• FLASH FIRMWARE
                    </button>
                </div>
            </div>
            
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">QUICK ACTIONS</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button onclick="resetSettings()" class="btn-cy py-2 rounded text-xs sm:text-sm">RESET TO DEFAULT</button>
                    <button onclick="exportLogs()" class="btn-cy py-2 rounded text-xs sm:text-sm">EXPORT LOGS</button>
                    <button onclick="calibrateSensor()" class="btn-cy py-2 rounded text-xs sm:text-sm">CALIBRATE SENSOR</button>
                    <button onclick="reconnectWS()" class="btn-cy py-2 rounded text-xs sm:text-sm">RECONNECT WEBSOCKET</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button onclick="switchView('main')" class="nav-btn active" id="nav-main">
            <span>üéÆ</span> <span class="hidden sm:inline">MAIN</span>
        </button>
        <button onclick="switchView('sensors')" class="nav-btn" id="nav-sensors">
            <span>üì°</span> <span class="hidden sm:inline">SENSORS</span>
        </button>
        <button onclick="switchView('settings')" class="nav-btn" id="nav-settings">
            <span>‚öô</span> <span class="hidden sm:inline">SETTINGS</span>
        </button>
    </div>

    <script>
        // === Global State ===
        let currentView = 'main';
        let sensorHistory = [];
        let socket;
        let wsConnected = false;
        
        // Canvas & Animation State
        const radarBlips = []; // { dist, angle, alpha, timestamp }
        let radarAngle = 0;
        let lastFrameTime = 0;

        // Chart Throttling
        let lastChartUpdate = 0;
        const CHART_THROTTLE_MS = 50; // Max 20fps for chart

        let controllerLinked = false;

        // === Initialization ===
        window.onload = () => {
            initWebSocket();
            initChart();
            resizeCanvas();
            requestAnimationFrame(animationLoop);
            fetchPorts();
            startStatusPolling();
            startXboxHeartbeat();

            // Initial Log
            log("System Initialized. Native WS mode active.");
            
        };

        window.addEventListener('resize', resizeCanvas);

        function resizeCanvas() {
            // Resize main radar
            const mainC = document.getElementById('radar-canvas-main');
            if(mainC) {
                mainC.width = mainC.parentElement.clientWidth;
                mainC.height = mainC.parentElement.clientHeight;
            }
            // Resize sensor radar
            const sensC = document.getElementById('radar-canvas-sensor');
            if(sensC) {
                sensC.width = sensC.parentElement.clientWidth;
                sensC.height = sensC.parentElement.clientHeight;
            }
            // Resize chart
            const chartC = document.getElementById('distance-chart');
            if(chartC) {
                chartC.width = chartC.parentElement.clientWidth;
                chartC.height = chartC.parentElement.clientHeight;
            }
        }

        // === Socket.IO Implementation ===
        function initWebSocket() {
            log("Connecting to Socket.IO...");
            socket = io({ transports: ['websocket'] });

            socket.on('connect', () => {
                wsConnected = true;
                document.getElementById('ws-status').innerText = "ONLINE";
                document.getElementById('ws-status').className = "text-green-500 font-bold animate-pulse";
                document.getElementById('link-text').innerText = "CONNECTED";
                document.getElementById('link-text').className = "text-green-500 font-bold animate-pulse";
                log("WS Connected");
            });

            socket.on('disconnect', () => {
                wsConnected = false;
                document.getElementById('ws-status').innerText = "OFFLINE";
                document.getElementById('ws-status').className = "text-red-500 font-bold";
                document.getElementById('link-text').innerText = "RETRYING...";
                document.getElementById('link-text').className = "text-yellow-500 font-bold";
                controllerLinked = false;
                lastXboxUpdate = 0;
                setGamepadLink(false);
                setTimeout(initWebSocket, 2000);
            });

            socket.on('controller_data', (data) => {
                controllerLinked = true;
                document.getElementById('gamepad-status').classList.add('gamepad-connected');
                updateXboxVisual(data.left_stick_x || 0, data.left_stick_y || 0, data.stick_pressed || false);
                if (data.cmd) {
                    highlightKey(data.cmd);
                }
            });
        }

        function reconnectWS() {
            if(socket) socket.close();
            initWebSocket();
        }

        // === Data Handling ===
        function handleData(data) {
            // Update IP
            const ipInput = document.getElementById('ip-input');
            if (ipInput && ipInput.value === "") {
                if (data.camera_ip) {
                    ipInput.value = data.camera_ip;
                } else if (data.ip) {
                    ipInput.value = data.ip;
                }
            }

            const settingsIp = document.getElementById('settings-ip');
            if (settingsIp && settingsIp.value === "" && data.car_ip) {
                settingsIp.value = data.car_ip;
            }
            
            // Port Status
            const portEl = document.getElementById('port-val');
            portEl.innerText = data.port || "DISCONNECTED";
            portEl.className = data.port ? "text-green-500 font-bold truncate max-w-[120px]" : "text-red-500 font-bold truncate max-w-[120px]";

            // Êõ¥Êñ∞ Settings ‰∏ãÊãâÈÅ∏ÂñÆÁöÑÈ°ØÁ§∫
            const portSelect = document.getElementById('port-select');
            if (portSelect && data.preferred_port && portSelect.value !== data.preferred_port) {
                portSelect.value = data.preferred_port;
            }

            // AI Status
            const aiStatus = document.getElementById('ai-status');
            const aiBtn = document.getElementById('ai-toggle-btn');
            if(data.ai_status) {
                aiStatus.innerText = 'ACTIVE';
                aiStatus.className = 'text-green-400 font-bold animate-pulse';
                aiBtn.innerText = 'DEACTIVATE AI';
                aiBtn.classList.add('btn-active');
            } else {
                aiStatus.innerText = 'STANDBY';
                aiStatus.className = 'text-gray-400 font-bold';
                aiBtn.innerText = 'ACTIVATE AI';
                aiBtn.classList.remove('btn-active');
            }

            // Radar & Distance
            const dist = parseFloat(data.dist);
            if (!isNaN(dist)) {
                document.getElementById('dist-val').innerText = dist.toFixed(1) + " CM";
                
                // Add Blip to Canvas Radar
                if(dist > 0 && dist < 100) {
                    // Random angle for visual effect since we assume 1D sonar
                    const angle = (Math.random() * 60 - 30 - 90) * (Math.PI/180); // Upward cone
                    radarBlips.push({
                        dist: dist,
                        angle: angle,
                        alpha: 1.0,
                        timestamp: performance.now()
                    });
                }
                
                if(currentView === 'sensors') {
                    updateSensorStats(dist);
                }
            }

            // Logs
            if(data.logs) {
                const box = document.getElementById('log-box');
                box.innerHTML = "";
                data.logs.forEach(l => {
                    const d = document.createElement('div');
                    d.innerText = l;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            }
        }

        // === Unified Animation Loop (rAF) ===
        function animationLoop(timestamp) {
            const dt = timestamp - lastFrameTime;
            lastFrameTime = timestamp;

            // 1. Draw Radars
            drawRadar(document.getElementById('radar-canvas-main'), timestamp, false);
            if(currentView === 'sensors') {
                drawRadar(document.getElementById('radar-canvas-sensor'), timestamp, true);
                
                // 2. Throttled Chart Update
                if (timestamp - lastChartUpdate > CHART_THROTTLE_MS) {
                    drawChart();
                    lastChartUpdate = timestamp;
                }
            }

            // 3. Poll Gamepad
            requestAnimationFrame(animationLoop);
        }

        // === Canvas Radar Logic ===
        function drawRadar(canvas, time, detailed) {
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const radius = Math.min(w, h) / 2 - 2;

            // Clear
            ctx.clearRect(0, 0, w, h);

            // Draw Grid
            ctx.strokeStyle = 'rgba(0, 255, 157, 0.2)';
            ctx.lineWidth = 1;
            
            // Circles
            ctx.beginPath(); ctx.arc(cx, cy, radius * 0.33, 0, Math.PI * 2); ctx.stroke();
            ctx.beginPath(); ctx.arc(cx, cy, radius * 0.66, 0, Math.PI * 2); ctx.stroke();
            ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI * 2); ctx.stroke();

            // Crosshairs
            ctx.beginPath(); ctx.moveTo(cx, cy - radius); ctx.lineTo(cx, cy + radius); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx - radius, cy); ctx.lineTo(cx + radius, cy); ctx.stroke();

            // Draw Sweep (Rotating Line)
            radarAngle = (time / 2000 * Math.PI * 2) % (Math.PI * 2); // 2 seconds per rev
            
            const grad = ctx.createConicGradient(radarAngle - Math.PI/2, cx, cy);
            grad.addColorStop(0, 'rgba(0, 255, 157, 0)');
            grad.addColorStop(0.8, 'rgba(0, 255, 157, 0.1)');
            grad.addColorStop(1, 'rgba(0, 255, 157, 0.5)');
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.fill();

            // Draw Blips
            for(let i = radarBlips.length - 1; i >= 0; i--) {
                const b = radarBlips[i];
                const age = time - b.timestamp;
                
                if(age > 1500) {
                    radarBlips.splice(i, 1);
                    continue;
                }

                const alpha = 1 - (age / 1500);
                const r = (b.dist / 100) * radius; // Map 0-100cm to radius
                
                const bx = cx + r * Math.cos(b.angle);
                const by = cy + r * Math.sin(b.angle);

                ctx.fillStyle = b.dist < 20 ? `rgba(239, 68, 68, ${alpha})` : `rgba(0, 255, 157, ${alpha})`;
                ctx.beginPath();
                ctx.arc(bx, by, detailed ? 4 : 3, 0, Math.PI * 2);
                ctx.fill();
                
                // Glow
                ctx.shadowBlur = 5;
                ctx.shadowColor = ctx.fillStyle;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        // === Command Sending (WS First, Fetch Fallback) ===
        function sendCmd(cmd) {
            highlightKey(cmd);
            
            // Try Socket.IO
            if(wsConnected && socket && socket.connected) {
                socket.emit('command', { cmd });
            } else {
                // Fallback HTTP
                fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cmd: cmd })
                }).catch(e => { /* Ignore fetch errors if offline */ });
            }
        }

        function highlightKey(cmd) {
            const map = {'F':'btn-w', 'L':'btn-a', 'S':'btn-s', 'R':'btn-d', 'B':'btn-x'};
            const id = map[cmd];
            if(id) {
                const btn = document.getElementById(id);
                btn.classList.add('btn-active');
                setTimeout(() => btn.classList.remove('btn-active'), 150);
            }
        }

        function updateXboxVisual(x, y, pressed) {
            const stick = document.getElementById('xbox-stick');
            if(!stick) return;
            const clamp = (v) => Math.max(-1, Math.min(1, v));
            const offset = 12;
            const dx = clamp(x) * offset;
            const dy = -clamp(y) * offset;
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            stick.classList.toggle('xbox-pulse', !!pressed);
        }

        function setGamepadLink(isConnected) {
            const icon = document.getElementById('gamepad-status');
            if (icon) {
                icon.classList.toggle('gamepad-connected', isConnected);
            }

            const linkEl = document.getElementById('xbox-link');
            if (linkEl) {
                linkEl.innerText = isConnected ? 'ONLINE' : 'OFFLINE';
                linkEl.className = isConnected ? 'text-green-400 font-bold' : 'text-red-500 font-bold';
            }

            if (!isConnected) {
                updateXboxCommand('--');
                updateXboxVisual(0, 0, false);
                updateXboxButtons({});
            }
        }

        function updateXboxCommand(cmd) {
            const cmdEl = document.getElementById('xbox-cmd');
            if (!cmdEl) return;
            cmdEl.innerText = cmd || '--';
            cmdEl.className = cmd ? 'text-yellow-400 font-mono font-bold' : 'text-gray-500';
        }

        function setButtonState(id, active) {
            const el = document.getElementById(id);
            if (!el) return;
            el.innerText = active ? 'ON' : 'OFF';
            el.className = active ? 'text-green-400 font-bold' : 'text-gray-500';
        }

        function setDpadState(x, y) {
            const el = document.getElementById('xbox-dpad');
            if (!el) return;
            let dir = '‚Äî';
            if (x || y) {
                const horiz = x > 0 ? '‚Üí' : x < 0 ? '‚Üê' : '';
                const vert = y > 0 ? '‚Üë' : y < 0 ? '‚Üì' : '';
                dir = `${vert}${horiz}` || '‚Äî';
            }
            el.innerText = dir;
            el.className = (x || y) ? 'text-green-400 font-bold' : 'text-gray-500';
        }

        function updateXboxButtons(data) {
            setButtonState('xbox-a', data.button_a);
            setButtonState('xbox-b', data.button_b);
            setButtonState('xbox-x', data.button_x);
            setButtonState('xbox-y', data.button_y);
            setButtonState('xbox-ls', data.stick_pressed);
            setDpadState(data.dpad_x || 0, data.dpad_y || 0);
        }

        function startXboxHeartbeat() {
            setInterval(() => {
                if (lastXboxUpdate && Date.now() - lastXboxUpdate > 2000) {
                    controllerLinked = false;
                    lastXboxUpdate = 0;
                    setGamepadLink(false);
                }
            }, 500);
        }

        // === Other Logic (Chart, Stats) ===
        function updateSensorStats(dist) {
            document.getElementById('sensor-distance-large').innerText = dist.toFixed(1) + " CM";
            
            sensorHistory.push(dist);
            if(sensorHistory.length > 50) sensorHistory.shift(); // Keep more history for chart
            
            const min = Math.min(...sensorHistory);
            const max = Math.max(...sensorHistory);
            const avg = (sensorHistory.reduce((a,b) => a+b, 0) / sensorHistory.length).toFixed(1);
            
            document.getElementById('sensor-min').innerText = min.toFixed(1);
            document.getElementById('sensor-max').innerText = max.toFixed(1);
            document.getElementById('sensor-avg').innerText = avg;
            document.getElementById('data-count').innerText = sensorHistory.length;
            
            // Zones
            const danger = document.getElementById('zone-danger');
            const warn = document.getElementById('zone-warning');
            const safe = document.getElementById('zone-safe');

            danger.innerText = dist < 20 ? "‚ö† ALERT" : "CLEAR";
            danger.className = dist < 20 ? "text-red-500 font-bold animate-pulse" : "text-gray-500";
            
            warn.innerText = (dist >= 20 && dist < 50) ? "‚ö† CAUTION" : "CLEAR";
            warn.className = (dist >= 20 && dist < 50) ? "text-yellow-500 font-bold" : "text-gray-500";
            
            safe.innerText = dist >= 50 ? "‚úì OK" : "CHECK";
            safe.className = dist >= 50 ? "text-green-500 font-bold" : "text-gray-500";
        }

        let chartCtx;
        function initChart() {
            const c = document.getElementById('distance-chart');
            if(c) {
                chartCtx = c.getContext('2d');
            }
        }

        function drawChart() {
            if(!chartCtx) return;
            const canvas = document.getElementById('distance-chart');
            const w = canvas.width;
            const h = canvas.height;
            const data = sensorHistory;

            chartCtx.clearRect(0, 0, w, h);
            
            // Grid
            chartCtx.strokeStyle = '#1f2937';
            chartCtx.lineWidth = 1;
            chartCtx.beginPath();
            chartCtx.moveTo(0, h/2); chartCtx.lineTo(w, h/2);
            chartCtx.stroke();

            if(data.length < 2) return;

            // Line
            chartCtx.strokeStyle = '#00ff9d';
            chartCtx.lineWidth = 2;
            chartCtx.beginPath();
            
            const step = w / (data.length - 1);
            const maxVal = 100; // Fixed scale for stability

            data.forEach((dist, i) => {
                const x = i * step;
                const y = h - (Math.min(dist, maxVal) / maxVal) * h;
                if(i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            });
            chartCtx.stroke();
        }

        // Helpers
        function log(msg) {
            const box = document.getElementById('log-box');
            if(box) {
                const time = new Date().toLocaleTimeString('en-GB');
                const d = document.createElement('div');
                d.innerHTML = `<span class="text-gray-600">[${time}]</span> ${msg}`;
                box.appendChild(d);
                box.scrollTop = box.scrollHeight;
            }
        }

        let lightState = false;
        function toggleLight() {
            lightState = !lightState;
            sendCmd(lightState ? 'W' : 'w');
            log(`LIGHTS: ${lightState ? 'ON' : 'OFF'}`);
        }

        function toggleAI() {
            fetch('/api/toggle_ai', { method: 'POST' });
        }
        
        function setManualIP() {
             const ip = document.getElementById('ip-input').value;
             if(ip) fetch('/api/set_ip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip, type: 'stream' })
             });
        }
        
        function applySettings() {
            const ip = document.getElementById('settings-ip').value;
            if(ip) {
                fetch('/api/set_ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, type: 'car' })
                });
                log(`Settings applied: CAR IP=${ip}`);
            }
            setPreferredPort();
        }

        function resetSettings() {
            document.getElementById('settings-ip').value = '';
            document.getElementById('auto-stop').checked = true;
            document.getElementById('collision-warn').checked = true;
            log('Settings reset to default.');
        }

        function exportLogs() {
            const logs = document.getElementById('log-box').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'logs.txt';
            a.click();
        }

        function calibrateSensor() {
            log('Sensor calibration initiated...');
            setTimeout(() => log('Calibration complete.'), 2000);
        }

        async function fetchPorts() {
            try {
                const res = await fetch('/api/ports');
                const data = await res.json();
                const select = document.getElementById('port-select');
                if (select && Array.isArray(data.ports)) {
                    select.innerHTML = '';
                    data.ports.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.device;
                        opt.textContent = `${p.device} (${p.description})`;
                        select.appendChild(opt);
                    });
                    if (data.preferred && data.ports.find(p => p.device === data.preferred)) {
                        select.value = data.preferred;
                    } else if (data.current && data.ports.find(p => p.device === data.current)) {
                        select.value = data.current;
                    }
                }
            } catch (err) {
                log('Failed to load COM ports');
            }
        }

        async function setPreferredPort() {
            const select = document.getElementById('port-select');
            if (!select || !select.value) return;
            try {
                const res = await fetch('/api/set_port', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: select.value })
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    log(`Preferred port set to ${select.value}`);
                } else if (data.msg) {
                    log(`Port set failed: ${data.msg}`);
                }
            } catch (err) {
                log('Port selection failed');
            }
        }

        function startStatusPolling() {
            setInterval(async () => {
                try {
                    const res = await fetch('/api/status');
                    const data = await res.json();
                    handleData(data);
                } catch (err) {
                    // ignore
                }
            }, 1000);
        }

        // === Firmware Flashing ===
        async function startFlashing() {
            const btn = document.getElementById('flash-btn');
            const progressContainer = document.getElementById('flash-progress-container');
            const progressBar = document.getElementById('flash-progress-bar');
            const progressText = document.getElementById('flash-progress-text');
            const statusText = document.getElementById('flash-status-text');

            if (!confirm('‚ö†Ô∏è WARNING: This will flash new firmware to your ESP32-S3 CAM.\n\nThe device will be temporarily disconnected during this process.\n\nContinue?')) {
                return;
            }

            btn.disabled = true;
            btn.innerText = '‚è≥ FLASHING...';
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '12%';
            progressText.innerText = '...';
            statusText.innerText = 'Starting flash (this may take up to a few minutes)...';
            statusText.className = 'text-xs text-orange-400 text-center';
            log('üî• Starting firmware flash process (check logs for progress)...');

            try {
                const res = await fetch('/api/flash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();
                const ok = data.status === 'ok';

                progressBar.style.width = '100%';
                progressText.innerText = ok ? '100%' : 'ERR';
                progressBar.classList.remove('bg-orange-500', 'bg-red-500', 'bg-green-500');
                progressBar.classList.add(ok ? 'bg-green-500' : 'bg-red-500');

                if (ok) {
                    statusText.innerText = '‚úÖ Firmware flash completed!';
                    statusText.className = 'text-xs text-green-400 text-center font-bold';
                    log('‚úÖ Firmware flash completed!');
                } else {
                    statusText.innerText = data.msg || 'Flash failed. See logs.';
                    statusText.className = 'text-xs text-red-400 text-center font-bold';
                    log(`‚ùå Flash failed: ${data.msg || 'unknown error'}`);
                }
            } catch (err) {
                progressBar.style.width = '100%';
                progressText.innerText = 'ERR';
                progressBar.classList.remove('bg-orange-500');
                progressBar.classList.add('bg-red-500');
                statusText.innerText = 'Flash request failed. Please retry.';
                statusText.className = 'text-xs text-red-400 text-center font-bold';
                log('‚ùå Flash request failed.');
            } finally {
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                    progressBar.classList.remove('bg-green-500', 'bg-red-500');
                    progressBar.classList.add('bg-orange-500');
                    progressText.innerText = '0%';
                    statusText.innerText = '';
                    statusText.className = '';
                    btn.disabled = false;
                    btn.innerText = 'üî• FLASH FIRMWARE';
                }, 2500);
            }
        }

        function switchView(view) {
            currentView = view;
            
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('sensors-view').style.display = 'none';
            document.getElementById('settings-view').style.display = 'none';
            
            if(view === 'main') {
                document.getElementById('main-view').style.display = 'grid';
            } else if(view === 'sensors') {
                document.getElementById('sensors-view').style.display = 'flex';
                // Trigger chart/canvas resize when view becomes visible
                setTimeout(resizeCanvas, 50); 
            } else if(view === 'settings') {
                document.getElementById('settings-view').style.display = 'block';
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('nav-' + view).classList.add('active');
            
            log(`Switched to ${view.toUpperCase()} view`);
        }
        
        // Keyboard Support
        document.addEventListener('keydown', (e) => {
            if(e.repeat) return;
            const k = e.key.toUpperCase();
            const map = {'W':'F', 'A':'L', 'S':'S', 'D':'R', 'X':'B', ' ':'S'};
            if(map[k]) sendCmd(map[k]);
        });

        document.addEventListener('keyup', (e) => {
            const k = e.key.toUpperCase();
            if(['W','A','D','X'].includes(k)) sendCmd('S');
        });

        // Clock
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

    </script>
</body>
</html>