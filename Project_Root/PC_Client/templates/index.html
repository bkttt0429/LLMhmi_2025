<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL COMMAND v13.0 RESPONSIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        body {
            background-color: #050505;
            color: #00ff9d;
            font-family: 'Share Tech Mono', monospace;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* --- Cyberpunk Visuals --- */
        .cyber-border {
            border: 1px solid #333;
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.1);
            background: rgba(10, 20, 20, 0.85);
            backdrop-filter: blur(4px);
        }

        .scan-line {
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.3) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            position: absolute;
            z-index: 10;
        }

        /* --- Buttons --- */
        .btn-cy {
            border: 1px solid #00ff9d;
            color: #00ff9d;
            background: rgba(0, 20, 10, 0.6);
            transition: all 0.1s;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .btn-cy:hover { background: #00ff9d; color: #000; box-shadow: 0 0 15px #00ff9d; }
        .btn-cy:active { transform: scale(0.95); }
        .btn-active { background: #00ff9d; color: #000; box-shadow: 0 0 15px #00ff9d; }

        /* --- Radar Animation --- */
        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .radar-sweep {
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 157, 0.5) 360deg);
            animation: radar-spin 2s linear infinite;
        }
        
        .blip {
            position: absolute;
            width: 8px; height: 8px;
            background: #ef4444;
            border-radius: 50%;
            box-shadow: 0 0 8px #ef4444;
            animation: fadeOut 1.5s forwards;
        }
        @keyframes fadeOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2); } }

        /* Nav Bar Styles */
        .nav-bar {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(10, 20, 20, 0.95);
            border: 1px solid #00ff9d;
            border-radius: 50px;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.3);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            max-width: 95vw;
        }

        .nav-btn {
            padding: 8px 12px;
            border: 1px solid #00ff9d;
            background: rgba(0, 20, 10, 0.6);
            color: #00ff9d;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        @media (min-width: 640px) {
            .nav-bar {
                gap: 10px;
                padding: 10px 20px;
            }
            
            .nav-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
                gap: 8px;
            }
        }

        .nav-btn:hover {
            background: #00ff9d;
            color: #000;
            box-shadow: 0 0 15px #00ff9d;
        }

        .nav-btn.active {
            background: #00ff9d;
            color: #000;
            box-shadow: 0 0 20px #00ff9d;
        }
    </style>
</head>
<body class="h-screen flex flex-col p-2 sm:p-4 gap-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-end border-b border-green-500/30 pb-2 shrink-0 gap-2">
        <div>
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-widest text-green-400 drop-shadow-[0_0_5px_rgba(0,255,157,0.8)]">SHIM INTERFACE <span class="text-xs sm:text-sm text-gray-500">v13.0</span></h1>
            <div class="text-[10px] sm:text-xs text-gray-400 tracking-wider">SECURE LINK ESTABLISHED // PYTHON BACKEND ACTIVE</div>
        </div>
        <div id="clock" class="text-lg sm:text-2xl text-green-600">00:00:00</div>
    </header>

    <!-- === MAIN VIEW === -->
    <div id="main-view" class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 min-h-0 pb-20">
        
        <!-- Left: Video Feed -->
        <div class="lg:col-span-8 flex flex-col gap-2 relative cyber-border rounded p-1 min-h-[300px]">
            <div class="flex justify-between px-2 text-[10px] sm:text-xs text-gray-500 font-bold flex-wrap gap-2">
                <div class="flex gap-2 items-center">
                    <span class="hidden sm:inline">TARGET IP:</span>
                    <input type="text" id="ip-input" class="bg-black text-green-400 border border-green-900 px-1 w-24 sm:w-32 focus:outline-none focus:border-green-500" placeholder="Waiting...">
                    <button onclick="setManualIP()" class="text-[10px] border border-green-700 px-1 sm:px-2 hover:bg-green-900">SET</button>
                </div>
                <span>FEED: <span class="text-green-400 animate-pulse">LIVE</span></span>
            </div>
            
            <!-- Video Area -->
            <div class="flex-1 bg-black relative overflow-hidden flex items-center justify-center border border-gray-800 group">
                <div class="scan-line"></div>
                <img src="/video_feed" class="w-full h-full object-contain" onerror="this.style.display='none'; document.getElementById('no-sig').style.display='flex'">
                
                <div id="no-sig" class="hidden absolute inset-0 flex-col items-center justify-center bg-black/80 z-20">
                    <div class="text-2xl sm:text-4xl text-red-500 font-bold border-4 border-red-500 p-4 sm:p-6 animate-pulse">NO SIGNAL</div>
                    <div class="text-red-400 mt-2 text-xs sm:text-sm">CHECK CONNECTION OR SERIAL PORT</div>
                </div>
                
                <!-- Crosshair Overlay -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30">
                    <div class="w-[40px] h-[40px] border border-green-500 rounded-full absolute"></div>
                    <div class="w-[200px] h-[1px] bg-green-500"></div>
                    <div class="h-[200px] w-[1px] bg-green-500 absolute"></div>
                </div>
            </div>

            <!-- Log Console -->
            <div id="log-box" class="h-24 sm:h-32 bg-black border-t border-gray-700 p-2 font-mono text-[10px] sm:text-xs overflow-y-auto text-gray-400 leading-tight">
                <div class="text-green-700">> Initializing Shim Interface...</div>
            </div>
        </div>

        <!-- Right: Controls -->
        <div class="lg:col-span-4 flex flex-col gap-4">
            
            <!-- Radar Panel -->
            <div class="cyber-border p-2 sm:p-4 flex flex-col items-center justify-center relative grow-0">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">SONAR ARRAY</div>
                
                <div class="w-32 h-32 sm:w-40 sm:h-40 lg:w-56 lg:h-56 rounded-full border border-green-900 relative overflow-hidden bg-black/80 shadow-[inset_0_0_20px_rgba(0,50,0,0.5)]">
                    <div class="absolute inset-0 rounded-full border border-green-500/20 scale-33"></div>
                    <div class="absolute inset-0 rounded-full border border-green-500/20 scale-66"></div>
                    <div class="absolute w-full h-[1px] top-1/2 bg-green-500/20"></div>
                    <div class="absolute h-full w-[1px] left-1/2 bg-green-500/20"></div>
                    <div class="absolute inset-0 rounded-full radar-sweep origin-center"></div>
                    <div id="radar-dots" class="absolute inset-0"></div>
                </div>
                
                <div id="dist-val" class="text-xl sm:text-2xl lg:text-3xl font-bold mt-2 text-green-400 drop-shadow-[0_0_5px_rgba(0,255,0,0.5)]">--.-- CM</div>
            </div>

            <!-- Manual Controls -->
            <div class="cyber-border p-3 sm:p-6 flex-1 flex flex-col justify-center gap-4 sm:gap-6 relative">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">MANUAL OVERRIDE</div>

                <div class="grid grid-cols-3 gap-2 sm:gap-3 w-full max-w-[180px] sm:max-w-[240px] mx-auto">
                    <div></div>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl" 
                            onmousedown="send('F')" onmouseup="send('S')"
                            ontouchstart="send('F')" ontouchend="send('S')" id="btn-w">W</button>
                    <div></div>
                    
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="send('L')" onmouseup="send('S')"
                            ontouchstart="send('L')" ontouchend="send('S')" id="btn-a">A</button>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="send('S')"
                            ontouchstart="send('S')" id="btn-s">S</button>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="send('R')" onmouseup="send('S')"
                            ontouchstart="send('R')" ontouchend="send('S')" id="btn-d">D</button>
                    
                    <div></div>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="send('B')" onmouseup="send('S')"
                            ontouchstart="send('B')" ontouchend="send('S')" id="btn-x">X</button>
                    <div></div>
                </div>

                <button class="btn-cy w-full py-2 sm:py-3 rounded tracking-widest text-xs sm:text-sm" onclick="toggleLight()">TOGGLE LIGHTS</button>
            </div>

            <!-- Status Footer -->
            <div class="cyber-border p-2 sm:p-3 text-[10px] sm:text-xs flex flex-col gap-1">
                <div class="flex justify-between">
                    <span class="text-gray-500">SERIAL PORT:</span>
                    <span id="port-val" class="text-yellow-500 font-bold truncate max-w-[120px]">SEARCHING...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">LINK STATUS:</span>
                    <span class="text-green-500 font-bold animate-pulse">ONLINE</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">AI STATUS:</span>
                    <span id="ai-status" class="text-gray-400 font-bold">STANDBY</span>
                </div>
                <button onclick="toggleAI()" id="ai-toggle-btn" class="btn-cy w-full py-2 mt-2 rounded text-[10px] sm:text-xs tracking-wider">
                    ACTIVATE AI
                </button>
            </div>

        </div>
    </div>

    <!-- === SENSORS VIEW === -->
    <div id="sensors-view" class="flex-1 flex flex-col lg:flex-row gap-4 min-h-0 pb-20 overflow-auto" style="display:none;">
        <!-- Left: Radar Visualization -->
        <div class="flex-[2] flex flex-col gap-2 min-h-[400px]">
            <div class="cyber-border rounded p-4 flex-1 relative overflow-hidden bg-black">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">ULTRASONIC RADAR</div>
                
                <!-- Radar Display -->
                <div class="absolute inset-0 flex items-center justify-center p-4">
                    <div class="w-full h-full max-w-[400px] max-h-[400px] lg:max-w-[500px] lg:max-h-[500px] rounded-full border border-green-900 relative overflow-hidden bg-black/80 shadow-[inset_0_0_40px_rgba(0,50,0,0.3)]">
                        <div class="absolute inset-[15%] rounded-full border border-green-500/20"></div>
                        <div class="absolute inset-[35%] rounded-full border border-green-500/20"></div>
                        <div class="absolute inset-[55%] rounded-full border border-green-500/20"></div>
                        <div class="absolute w-full h-[1px] top-1/2 bg-green-500/20"></div>
                        <div class="absolute h-full w-[1px] left-1/2 bg-green-500/20"></div>
                        <div class="absolute inset-0 rounded-full radar-sweep origin-center"></div>
                        <div id="radar-dots-sensor" class="absolute inset-0"></div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                </div>
            </div>
            
            <!-- Distance History Chart -->
            <div class="cyber-border rounded p-3 h-32 bg-black">
                <div class="text-[10px] text-gray-500 mb-1">DISTANCE HISTORY (LAST 20 SAMPLES)</div>
                <canvas id="distance-chart" class="w-full h-full"></canvas>
            </div>
        </div>

        <!-- Right: Sensor Data -->
        <div class="flex-1 cyber-border rounded p-4 flex flex-col gap-3 min-w-[280px]">
            <div class="text-sm text-green-400 font-bold border-b border-green-900 pb-2">SENSOR TELEMETRY</div>
            
            <!-- Current Distance -->
            <div class="cyber-border p-3 rounded bg-black/60">
                <div class="text-xs text-gray-400 mb-1">Current Distance</div>
                <div id="sensor-distance-large" class="text-4xl sm:text-5xl font-bold font-mono text-green-400">--.-- CM</div>
                <div class="mt-2 flex gap-2 text-xs">
                    <div class="flex-1 bg-gray-800 rounded p-1">
                        <div class="text-gray-500">MIN</div>
                        <div id="sensor-min" class="text-yellow-400 font-mono">‚àû</div>
                    </div>
                    <div class="flex-1 bg-gray-800 rounded p-1">
                        <div class="text-gray-500">MAX</div>
                        <div id="sensor-max" class="text-yellow-400 font-mono">0</div>
                    </div>
                    <div class="flex-1 bg-gray-800 rounded p-1">
                        <div class="text-gray-500">AVG</div>
                        <div id="sensor-avg" class="text-yellow-400 font-mono">0</div>
                    </div>
                </div>
            </div>

            <!-- Alert Zones -->
            <div class="cyber-border p-3 rounded bg-black/60">
                <div class="text-xs text-gray-400 mb-2">ALERT ZONES</div>
                <div class="space-y-2 text-xs">
                    <div class="flex items-center justify-between">
                        <span class="text-red-400">‚óè DANGER (&lt;20cm)</span>
                        <span id="zone-danger" class="text-gray-500">CLEAR</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-yellow-400">‚óè WARNING (20-50cm)</span>
                        <span id="zone-warning" class="text-gray-500">CLEAR</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-green-400">‚óè SAFE (&gt;50cm)</span>
                        <span id="zone-safe" class="text-green-500">OK</span>
                    </div>
                </div>
            </div>

            <!-- Sensor Status -->
            <div class="cyber-border p-3 rounded bg-black/60 mt-auto">
                <div class="text-xs text-gray-400 mb-2">SENSOR STATUS</div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>
                        <div class="text-gray-500">Sampling Rate</div>
                        <div class="text-green-400 font-mono">500ms</div>
                    </div>
                    <div>
                        <div class="text-gray-500">Data Points</div>
                        <div id="data-count" class="text-green-400 font-mono">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === SETTINGS VIEW === -->
    <div id="settings-view" class="flex-1 overflow-auto p-2 sm:p-4 pb-20" style="display:none;">
        <div class="max-w-3xl mx-auto space-y-4">
            <!-- Connection Settings -->
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 flex items-center gap-2 text-sm sm:text-base">
                    <span class="text-xl">‚öô</span> CONNECTION SETTINGS
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Target IP Address</label>
                        <input id="settings-ip" type="text" class="w-full bg-black text-green-400 border border-green-900 px-2 py-1 rounded focus:outline-none focus:border-green-500 text-sm" placeholder="192.168.x.x">
                    </div>
                    <button onclick="applySettings()" class="btn-cy w-full py-2 rounded text-sm">APPLY SETTINGS</button>
                </div>
            </div>

            <!-- Control Settings -->
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">CONTROL SETTINGS</div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs sm:text-sm text-gray-300">Auto-Stop on Obstacle</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input id="auto-stop" type="checkbox" checked class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs sm:text-sm text-gray-300">Enable Collision Warning</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input id="collision-warn" type="checkbox" checked class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- System Info -->
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">SYSTEM INFORMATION</div>
                <div class="space-y-2 text-xs sm:text-sm font-mono">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Interface Version:</span>
                        <span class="text-green-400">v13.0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Backend Status:</span>
                        <span class="text-green-400">ACTIVE</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Protocol:</span>
                        <span class="text-green-400">HTTP/REST</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">QUICK ACTIONS</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button onclick="resetSettings()" class="btn-cy py-2 rounded text-xs sm:text-sm">RESET TO DEFAULT</button>
                    <button onclick="exportLogs()" class="btn-cy py-2 rounded text-xs sm:text-sm">EXPORT LOGS</button>
                    <button onclick="calibrateSensor()" class="btn-cy py-2 rounded text-xs sm:text-sm">CALIBRATE SENSOR</button>
                    <button onclick="testConnection()" class="btn-cy py-2 rounded text-xs sm:text-sm">TEST CONNECTION</button>
                </div>
            </div>
        </div>
    </div>

    <!-- === NAVIGATION BAR === -->
    <div class="nav-bar">
        <button onclick="switchView('main')" class="nav-btn active" id="nav-main">
            <span>üéÆ</span> <span class="hidden sm:inline">MAIN</span>
        </button>
        <button onclick="switchView('sensors')" class="nav-btn" id="nav-sensors">
            <span>üì°</span> <span class="hidden sm:inline">SENSORS</span>
        </button>
        <button onclick="switchView('settings')" class="nav-btn" id="nav-settings">
            <span>‚öô</span> <span class="hidden sm:inline">SETTINGS</span>
        </button>
    </div>

    <script>
        // === Global State ===
        let currentView = 'main';
        let sensorHistory = [];

        // === Core Logic ===
        
        // Helper: Add Log
        function log(msg) {
            const box = document.getElementById('log-box');
            const time = new Date().toLocaleTimeString('en-GB');
            const d = document.createElement('div');
            d.innerHTML = `<span class="text-gray-600">[${time}]</span> ${msg}`;
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        // === View Switching ===
        function switchView(view) {
            currentView = view;
            
            // Hide all views
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('sensors-view').style.display = 'none';
            document.getElementById('settings-view').style.display = 'none';
            
            // Show selected view
            if(view === 'main') {
                document.getElementById('main-view').style.display = 'grid';
            } else if(view === 'sensors') {
                document.getElementById('sensors-view').style.display = 'flex';
            } else if(view === 'settings') {
                document.getElementById('settings-view').style.display = 'block';
            }
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('nav-' + view).classList.add('active');
            
            log(`Switched to ${view.toUpperCase()} view`);
        }

        // Function: Send Command to Python
        async function send(cmd) {
            // Prevent default touch actions
            if(event && event.cancelable) event.preventDefault();
            
            try {
                await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cmd: cmd })
                });
                highlightKey(cmd);
            } catch(e) { console.error(e); }
        }

        // Function: Set Manual IP
        function setManualIP() {
            const ip = document.getElementById('ip-input').value;
            if(ip) {
                fetch('/api/set_ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip })
                });
                log(`Manual IP Set: ${ip}`);
                setTimeout(() => {
                    const img = document.querySelector('img');
                    img.src = '/video_feed?' + new Date().getTime();
                }, 1000);
            }
        }

        let lightState = false;
        function toggleLight() {
            lightState = !lightState;
            send(lightState ? 'W' : 'w');
            log(`LIGHTS: ${lightState ? 'ON' : 'OFF'}`);
        }

        // === AI Toggle Function ===
        async function toggleAI() {
            try {
                const res = await fetch('/api/toggle_ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                
                if(data.status === 'ok') {
                    const btn = document.getElementById('ai-toggle-btn');
                    const status = document.getElementById('ai-status');
                    
                    if(data.ai_enabled) {
                        btn.innerText = 'DEACTIVATE AI';
                        btn.classList.add('btn-active');
                        status.innerText = 'ACTIVE';
                        status.className = 'text-green-400 font-bold animate-pulse';
                        log('ü§ñ AI Detection ACTIVATED');
                    } else {
                        btn.innerText = 'ACTIVATE AI';
                        btn.classList.remove('btn-active');
                        status.innerText = 'STANDBY';
                        status.className = 'text-gray-400 font-bold';
                        log('ü§ñ AI Detection DEACTIVATED');
                    }
                } else {
                    log(`‚ùå AI Toggle Failed: ${data.msg}`);
                }
            } catch(e) {
                log('‚ùå AI Toggle Error');
                console.error(e);
            }
        }

        // === Polling Loop (Sync Status) ===
        setInterval(async () => {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                
                // Update IP Input if auto-detected
                const ipInput = document.getElementById('ip-input');
                const newIp = data.ip;
                if (newIp && ipInput.value === "") {
                    ipInput.value = newIp;
                    log(`Auto-detected IP: ${newIp}`);
                }

                // Try to reload video if IP available
                const img = document.querySelector('img[src*="/video_feed"]');
                const noSigDiv = document.getElementById('no-sig');
                if (newIp && noSigDiv.style.display !== 'none') {
                    log(`Attempting to connect...`);
                    noSigDiv.style.display = 'none';
                    img.style.display = 'block';
                    img.src = '/video_feed?' + new Date().getTime();
                }
                
                // Update Port Status
                const portEl = document.getElementById('port-val');
                portEl.innerText = data.port || "DISCONNECTED";
                portEl.className = data.port ? "text-green-500 font-bold truncate max-w-[120px]" : "text-red-500 font-bold truncate max-w-[120px]";

                // Update AI Status
                const aiStatus = document.getElementById('ai-status');
                const aiBtn = document.getElementById('ai-toggle-btn');
                if(data.ai_status) {
                    aiStatus.innerText = 'ACTIVE';
                    aiStatus.className = 'text-green-400 font-bold animate-pulse';
                    aiBtn.innerText = 'DEACTIVATE AI';
                    aiBtn.classList.add('btn-active');
                } else {
                    aiStatus.innerText = 'STANDBY';
                    aiStatus.className = 'text-gray-400 font-bold';
                    aiBtn.innerText = 'ACTIVATE AI';
                    aiBtn.classList.remove('btn-active');
                }

                // Update Radar & Sensors
                const dist = parseFloat(data.dist);
                if (!isNaN(dist)) {
                    document.getElementById('dist-val').innerText = dist.toFixed(1) + " CM";
                    if(dist > 0 && dist < 50) addRadarBlip(dist);
                    
                    if(currentView === 'sensors') {
                        updateSensorView(dist);
                    }
                }

                // Sync Logs
                const box = document.getElementById('log-box');
                box.innerHTML = "";
                data.logs.forEach(l => {
                    const d = document.createElement('div');
                    d.innerText = l;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;

            } catch(e) {
                // Backend offline
            }
        }, 500);

        // === Sensor View Updates ===
        function updateSensorView(dist) {
            document.getElementById('sensor-distance-large').innerText = dist.toFixed(1) + " CM";
            
            sensorHistory.push(dist);
            if(sensorHistory.length > 20) sensorHistory.shift();
            
            const min = Math.min(...sensorHistory);
            const max = Math.max(...sensorHistory);
            const avg = (sensorHistory.reduce((a,b) => a+b, 0) / sensorHistory.length).toFixed(1);
            
            document.getElementById('sensor-min').innerText = min.toFixed(1);
            document.getElementById('sensor-max').innerText = max.toFixed(1);
            document.getElementById('sensor-avg').innerText = avg;
            document.getElementById('data-count').innerText = sensorHistory.length;
            
            if(dist < 20) {
                document.getElementById('zone-danger').innerText = "‚ö† ALERT";
                document.getElementById('zone-danger').className = "text-red-500 font-bold animate-pulse";
            } else {
                document.getElementById('zone-danger').innerText = "CLEAR";
                document.getElementById('zone-danger').className = "text-gray-500";
            }
            
            if(dist >= 20 && dist < 50) {
                document.getElementById('zone-warning').innerText = "‚ö† CAUTION";
                document.getElementById('zone-warning').className = "text-yellow-500 font-bold";
            } else {
                document.getElementById('zone-warning').innerText = "CLEAR";
                document.getElementById('zone-warning').className = "text-gray-500";
            }
            
            if(dist >= 50) {
                document.getElementById('zone-safe').innerText = "‚úì OK";
                document.getElementById('zone-safe').className = "text-green-500 font-bold";
            } else {
                document.getElementById('zone-safe').innerText = "CHECK";
                document.getElementById('zone-safe').className = "text-gray-500";
            }
            
            if(dist > 0 && dist < 100) {
                addSensorRadarBlip(dist);
            }
            
            updateDistanceChart();
        }

        // === Sensor Radar Blip ===
        function addSensorRadarBlip(dist) {
            const container = document.getElementById('radar-dots-sensor');
            const blip = document.createElement('div');
            
            const r = (dist / 100) * 45; 
            const angle = (Math.random() * 90 - 45 + 90) * (Math.PI / 180); 
            
            const x = 50 + r * Math.cos(angle);
            const y = 50 + r * Math.sin(angle);

            blip.className = 'blip';
            blip.style.left = x + '%';
            blip.style.top = y + '%';
            blip.style.background = dist < 20 ? '#ef4444' : dist < 50 ? '#eab308' : '#22c55e';
            
            container.appendChild(blip);
            setTimeout(() => blip.remove(), 1500);
        }

        // === Distance Chart ===
        let chartCanvas, chartCtx;
        function initChart() {
            chartCanvas = document.getElementById('distance-chart');
            if(chartCanvas) {
                chartCtx = chartCanvas.getContext('2d');
                chartCanvas.width = chartCanvas.offsetWidth;
                chartCanvas.height = chartCanvas.offsetHeight;
            }
        }

        function updateDistanceChart() {
            if(!chartCtx || !chartCanvas) return;
            
            const w = chartCanvas.width;
            const h = chartCanvas.height;
            const data = sensorHistory;
            
            chartCtx.clearRect(0, 0, w, h);
            
            if(data.length < 2) return;
            
            chartCtx.strokeStyle = '#1f2937';
            chartCtx.lineWidth = 1;
            for(let i = 0; i < 5; i++) {
                const y = (h / 4) * i;
                chartCtx.beginPath();
                chartCtx.moveTo(0, y);
                chartCtx.lineTo(w, y);
                chartCtx.stroke();
            }
            
            chartCtx.strokeStyle = '#00ff9d';
            chartCtx.lineWidth = 2;
            chartCtx.beginPath();
            
            const step = w / (data.length - 1);
            const maxDist = 100;
            
            data.forEach((dist, i) => {
                const x = i * step;
                const y = h - (dist / maxDist) * h;
                
                if(i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            });
            
            chartCtx.stroke();
        }

        // === Settings Functions ===
        function applySettings() {
            const ip = document.getElementById('settings-ip').value;
            if(ip) {
                fetch('/api/set_ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip })
                });
                log(`Settings applied: IP=${ip}`);
            }
        }

        function resetSettings() {
            document.getElementById('settings-ip').value = '';
            document.getElementById('auto-stop').checked = true;
            document.getElementById('collision-warn').checked = true;
            log('Settings reset to default.');
        }

        function exportLogs() {
            const logs = document.getElementById('log-box').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'shim_logs_' + Date.now() + '.txt';
            a.click();
            log('Logs exported.');
        }

        function calibrateSensor() {
            log('Sensor calibration initiated...');
            setTimeout(() => log('Calibration complete.'), 2000);
        }

        function testConnection() {
            log('Testing connection...');
            fetch('/api/status')
                .then(() => log('‚úì Connection test successful.'))
                .catch(() => log('‚úó Connection test failed.'));
        }

        // === Visual Effects ===
        function addRadarBlip(dist) {
            const container = document.getElementById('radar-dots');
            const blip = document.createElement('div');
            
            const r = (dist / 50) * 45; 
            const angle = (Math.random() * 90 + 225) * (Math.PI / 180); 
            
            const x = 50 + r * Math.cos(angle);
            const y = 50 + r * Math.sin(angle);

            blip.className = 'blip';
            blip.style.left = x + '%';
            blip.style.top = y + '%';
            
            container.appendChild(blip);
            setTimeout(() => blip.remove(), 1500);
        }

        function highlightKey(cmd) {
            const map = {'F':'btn-w', 'L':'btn-a', 'S':'btn-s', 'R':'btn-d', 'B':'btn-x'};
            const id = map[cmd];
            if(id) {
                const btn = document.getElementById(id);
                btn.classList.add('btn-active');
                setTimeout(() => btn.classList.remove('btn-active'), 150);
            }
        }

        // === Keyboard Controls ===
        document.addEventListener('keydown', (e) => {
            if(e.repeat) return;
            const k = e.key.toUpperCase();
            const map = {'W':'F', 'A':'L', 'S':'S', 'D':'R', 'X':'B', ' ':'S'};
            if(map[k]) send(map[k]);
        });

        document.addEventListener('keyup', (e) => {
            const k = e.key.toUpperCase();
            if(['W','A','D','X'].includes(k)) send('S');
        });

        // Clock
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        // Initialize
        initChart();

    </script>
</body>
</html>