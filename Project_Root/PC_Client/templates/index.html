<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL COMMAND v15.0 [DUAL-LINK]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        body {
            background-color: #050505;
            color: #00ff9d;
            font-family: 'Share Tech Mono', monospace;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* --- Cyberpunk Visuals --- */
        .cyber-border {
            border: 1px solid #333;
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.1);
            background: rgba(10, 20, 20, 0.85);
            backdrop-filter: blur(4px);
        }

        .scan-line {
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.3) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            position: absolute;
            z-index: 10;
        }

        /* --- Buttons --- */
        .btn-cy {
            border: 1px solid #00ff9d;
            color: #00ff9d;
            background: rgba(0, 20, 10, 0.6);
            transition: all 0.1s;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .btn-cy:hover { background: #00ff9d; color: #000; box-shadow: 0 0 15px #00ff9d; }
        .btn-cy:active { transform: scale(0.95); }
        .btn-active { background: #00ff9d; color: #000; box-shadow: 0 0 15px #00ff9d; }

        /* Nav Bar Styles */
        .nav-bar {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(10, 20, 20, 0.95);
            border: 1px solid #00ff9d;
            border-radius: 50px;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.3);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            max-width: 95vw;
        }

        .nav-btn {
            padding: 8px 12px;
            border: 1px solid #00ff9d;
            background: rgba(0, 20, 10, 0.6);
            color: #00ff9d;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        @media (min-width: 640px) {
            .nav-bar { gap: 10px; padding: 10px 20px; }
            .nav-btn { padding: 10px 20px; font-size: 0.9rem; gap: 8px; }
        }

        .nav-btn:hover { background: #00ff9d; color: #000; box-shadow: 0 0 15px #00ff9d; }
        .nav-btn.active { background: #00ff9d; color: #000; box-shadow: 0 0 20px #00ff9d; }
        
        /* Xbox Visualizer */
        .xbox-card {
            background: radial-gradient(circle at 20% 20%, rgba(0,255,157,0.06), transparent 35%),
                        radial-gradient(circle at 80% 0%, rgba(0,255,255,0.06), transparent 30%),
                        rgba(5, 15, 10, 0.85);
            border: 1px solid rgba(0,255,157,0.2);
            box-shadow: 0 0 25px rgba(0,255,157,0.08);
        }
        .xbox-stick {
            width: 64px; height: 64px;
            border: 1px solid #0f766e;
            border-radius: 50%;
            background: radial-gradient(circle, #0b1f1a 0%, #04100c 65%);
            box-shadow: inset 0 0 12px rgba(0,255,157,0.35);
            transition: transform 0.1s ease-out;
        }
        .xbox-stick::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 14px; height: 14px;
            background: #00ff9d;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px rgba(0,255,157,0.6);
        }
        .xbox-pulse {
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.35; }
            50% { opacity: 1; }
            100% { opacity: 0.35; }
        }
    </style>
</head>
<body class="h-screen flex flex-col p-2 sm:p-4 gap-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">

    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-end border-b border-green-500/30 pb-2 shrink-0 gap-2">
        <div>
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-widest text-green-400 drop-shadow-[0_0_5px_rgba(0,255,157,0.8)]">SHIM INTERFACE <span class="text-xs sm:text-sm text-gray-500">v15.0 DUAL-LINK</span></h1>
            <div class="text-[10px] sm:text-xs text-gray-400 tracking-wider flex items-center gap-4 flex-wrap">
                <div class="flex items-center gap-1">
                    <span>CONTROL(UDP):</span> 
                    <span id="car-ip-display" class="text-yellow-500 font-bold">--.--.--.--</span>
                </div>
                <div class="flex items-center gap-1">
                    <span>VIDEO:</span> 
                    <span id="cam-ip-display" class="text-blue-400 font-bold">--.--.--.--</span>
                </div>
                <span id="gamepad-status" class="opacity-30 transition-opacity flex items-center gap-1">üéÆ GAMEPAD</span>
            </div>
        </div>
        <div id="clock" class="text-lg sm:text-2xl text-green-600">00:00:00</div>
    </header>

    <div id="main-view" class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 min-h-0 pb-20">
        
        <div class="lg:col-span-8 flex flex-col gap-2 relative cyber-border rounded p-1 min-h-[300px]">
            <div class="flex justify-between px-2 text-[10px] sm:text-xs text-gray-500 font-bold flex-wrap gap-2">
                <div class="flex gap-2 items-center text-green-600">
                    SYSTEM STATUS: <span class="text-green-400">OPERATIONAL</span>
                </div>
                <span>FEED: <span class="text-green-400 animate-pulse">LIVE</span></span>
            </div>
            
            <div class="flex-1 bg-black relative overflow-hidden flex items-center justify-center border border-gray-800 group">
                <div class="scan-line"></div>
                <img src="/video_feed" class="w-full h-full object-contain" onerror="this.style.display='none'; document.getElementById('no-sig').style.display='flex'">
                
                <div id="no-sig" class="hidden absolute inset-0 flex-col items-center justify-center bg-black/80 z-20">
                    <div class="text-2xl sm:text-4xl text-red-500 font-bold border-4 border-red-500 p-4 sm:p-6 animate-pulse">NO SIGNAL</div>
                    <div class="text-red-400 mt-2 text-xs sm:text-sm">CHECK ESP32-S3 (CAMERA)</div>
                </div>
                
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30">
                    <div class="w-[40px] h-[40px] border border-green-500 rounded-full absolute"></div>
                    <div class="w-[200px] h-[1px] bg-green-500"></div>
                    <div class="h-[200px] w-[1px] bg-green-500 absolute"></div>
                </div>
            </div>

            <div id="log-box" class="h-24 sm:h-32 bg-black border-t border-gray-700 p-2 font-mono text-[10px] sm:text-xs overflow-y-auto text-gray-400 leading-tight">
                <div class="text-green-700">> Initializing Dual-Link Interface...</div>
            </div>
        </div>

        <div class="lg:col-span-4 flex flex-col gap-4">
            
            <div class="cyber-border p-2 sm:p-4 flex flex-col items-center justify-center relative grow-0">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">SONAR (ESP12F)</div>
                
                <div class="relative w-32 h-32 sm:w-40 sm:h-40 lg:w-56 lg:h-56 rounded-full border border-green-900 bg-black/80 shadow-[inset_0_0_20px_rgba(0,50,0,0.5)]">
                     <canvas id="radar-canvas-main" class="absolute inset-0 w-full h-full rounded-full"></canvas>
                </div>
                
                <div id="dist-val" class="text-xl sm:text-2xl lg:text-3xl font-bold mt-2 text-green-400 drop-shadow-[0_0_5px_rgba(0,255,0,0.5)]">--.-- CM</div>
            </div>

            <div class="cyber-border p-3 sm:p-6 flex-1 flex flex-col justify-center gap-4 sm:gap-6 relative">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">MANUAL OVERRIDE</div>

                <div class="grid grid-cols-3 gap-2 sm:gap-3 w-full max-w-[180px] sm:max-w-[240px] mx-auto">
                    <div></div>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl" 
                            onmousedown="sendCmd('F')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('F')" ontouchend="sendCmd('S')" id="btn-w">W</button>
                    <div></div>
                    
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="sendCmd('L')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('L')" ontouchend="sendCmd('S')" id="btn-a">A</button>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="sendCmd('S')"
                            ontouchstart="sendCmd('S')" id="btn-s">S</button>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="sendCmd('R')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('R')" ontouchend="sendCmd('S')" id="btn-d">D</button>
                    
                    <div></div>
                    <button class="btn-cy h-10 sm:h-12 lg:h-14 rounded text-base sm:text-lg lg:text-xl"
                            onmousedown="sendCmd('B')" onmouseup="sendCmd('S')"
                            ontouchstart="sendCmd('B')" ontouchend="sendCmd('S')" id="btn-x">X</button>
                    <div></div>
                </div>

                <button class="btn-cy w-full py-2 sm:py-3 rounded tracking-widest text-xs sm:text-sm" onclick="toggleLight()">TOGGLE LIGHTS (ESP32 CAM)</button>
            </div>

            <div class="xbox-card rounded p-3 sm:p-4 flex flex-col gap-3 relative">
                <div class="absolute top-2 left-2 text-[10px] text-gray-500 tracking-widest">XBOX TELEMETRY</div>
                <div class="flex items-center gap-4">
                    <div class="relative xbox-stick" id="xbox-stick"></div>
                    <div class="space-y-1 text-xs sm:text-sm text-gray-300">
                        <div class="flex items-center gap-2"><span class="text-green-400 font-mono">LS</span>ÔºöÁßªÂãïÊéßÂà∂</div>
                        <div class="flex items-center gap-2"><span class="text-green-400 font-mono">X</span>ÔºöÁ∑äÊÄ•ÁÖûËªä</div>
                        <div class="flex items-center gap-2"><span class="text-green-400 font-mono">A</span>ÔºöË£úÂÖâÁáà (CAM)</div>
                    </div>
                </div>
                <div class="flex items-center justify-between text-[10px] sm:text-xs text-gray-400">
                    <div>CMD: <span id="xbox-cmd" class="text-yellow-400 font-mono">--</span></div>
                    <div id="ai-status" class="text-gray-500">AI: STANDBY</div>
                </div>
            </div>

        </div>
    </div>

    <!-- Settings View -->
    <div id="settings-view" class="flex-1 overflow-auto p-2 sm:p-4 pb-20" style="display:none;">
        <div class="max-w-3xl mx-auto space-y-4">
            
            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 flex items-center gap-2 text-sm sm:text-base">
                    <span class="text-xl">üì°</span> DUAL-LINK CONNECTION
                </div>
                <div class="space-y-4">
                    <div class="p-3 border border-green-900/50 rounded bg-green-900/10">
                        <label class="block text-xs text-green-400 mb-1 font-bold">üöó Car Control IP (ESP12F)</label>
                        <div class="text-[10px] text-gray-500 mb-2">Êé•Êî∂ UDP Êåá‰ª§ÁöÑÈÅôÊéßËªä (Port 4210)</div>
                        <input id="settings-car-ip" type="text" class="w-full bg-black text-green-400 border border-green-900 px-2 py-2 rounded focus:outline-none focus:border-green-500 text-sm font-mono" placeholder="192.168.x.x">
                    </div>
                    
                    <div class="p-3 border border-blue-900/50 rounded bg-blue-900/10">
                        <label class="block text-xs text-blue-400 mb-1 font-bold">üìπ Camera Stream IP (ESP32-S3)</label>
                        <div class="text-[10px] text-gray-500 mb-2">Êèê‰æõÂΩ±ÂÉè‰∏≤ÊµÅ (Port 81)</div>
                        <input id="settings-cam-ip" type="text" class="w-full bg-black text-blue-400 border border-blue-900 px-2 py-2 rounded focus:outline-none focus:border-blue-500 text-sm font-mono" placeholder="192.168.x.x">
                    </div>

                    <button onclick="applySettings()" class="btn-cy w-full py-3 rounded text-sm font-bold">APPLY DUAL IP SETTINGS</button>
                </div>
            </div>

            <div class="cyber-border rounded p-3 sm:p-4 bg-black/60">
                <div class="text-green-400 font-bold mb-3 text-sm sm:text-base">SYSTEM TOOLS</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                     <button onclick="toggleAI()" id="ai-toggle-btn" class="btn-cy py-2 rounded text-xs sm:text-sm">ACTIVATE AI HUD</button>
                     <button onclick="exportLogs()" class="btn-cy py-2 rounded text-xs sm:text-sm">EXPORT SYSTEM LOGS</button>
                     <button onclick="showNetInfo()" class="btn-cy py-2 rounded text-xs sm:text-sm text-blue-300 border-blue-500">SHOW NET INFO</button>
                </div>
            </div>
            
        </div>
    </div>

    <div class="nav-bar">
        <button onclick="switchView('main')" class="nav-btn active" id="nav-main">
            <span>üéÆ</span> <span class="hidden sm:inline">COMMAND</span>
        </button>
        <button onclick="switchView('settings')" class="nav-btn" id="nav-settings">
            <span>‚öô</span> <span class="hidden sm:inline">SYSTEM</span>
        </button>
    </div>

    <script>
        // === Global State ===
        let currentView = 'main';
        let socket;
        let wsConnected = false;
        let lastLogs = [];
        
        // Canvas State
        const radarBlips = [];
        let radarAngle = 0;
        let lastFrameTime = 0;
        let controllerLinked = false;
        let lastXboxUpdate = 0;

        window.onload = () => {
            initWebSocket();
            resizeCanvas();
            requestAnimationFrame(animationLoop);
            startStatusPolling(); // Ëá™ÂãïËº™Ë©¢ IP ÁãÄÊÖã
            log("System Initialized. Dual-Link Mode Active.");
        };

        window.addEventListener('resize', resizeCanvas);

        function resizeCanvas() {
            const mainC = document.getElementById('radar-canvas-main');
            if(mainC) {
                mainC.width = mainC.parentElement.clientWidth;
                mainC.height = mainC.parentElement.clientHeight;
            }
        }

        function initWebSocket() {
            socket = io({ transports: ['websocket'] });
            socket.on('connect', () => { wsConnected = true; log("WS Connected"); });
            socket.on('disconnect', () => { wsConnected = false; log("WS Disconnected"); });
            
            socket.on('controller_data', (data) => {
                controllerLinked = true;
                lastXboxUpdate = Date.now();
                updateXboxVisual(data.left_stick_x || 0, data.left_stick_y || 0, data.stick_pressed || false);
                if (data.cmd) {
                    document.getElementById('xbox-cmd').innerText = data.cmd;
                    highlightKey(data.cmd);
                }
                const icon = document.getElementById('gamepad-status');
                if(icon) icon.style.opacity = '1';
            });
        }

        // === Data Handling (Polling Status) ===
        function startStatusPolling() {
            setInterval(async () => {
                try {
                    const res = await fetch('/api/status');
                    const data = await res.json();
                    
                    // Êõ¥Êñ∞ header ÁöÑ IP È°ØÁ§∫
                    const carIpDisplay = document.getElementById('car-ip-display');
                    const camIpDisplay = document.getElementById('cam-ip-display');
                    
                    if(data.car_ip) {
                        carIpDisplay.innerText = data.car_ip;
                        carIpDisplay.className = "text-green-400 font-bold font-mono";
                        // ÂêåÊ≠•Êõ¥Êñ∞ Settings Ê¨Ñ‰Ωç
                        const setCar = document.getElementById('settings-car-ip');
                        if(setCar && !setCar.value) setCar.value = data.car_ip;
                    }
                    
                    if(data.camera_ip) {
                        camIpDisplay.innerText = data.camera_ip;
                        camIpDisplay.className = "text-blue-400 font-bold font-mono";
                        // ÂêåÊ≠•Êõ¥Êñ∞ Settings Ê¨Ñ‰Ωç
                        const setCam = document.getElementById('settings-cam-ip');
                        if(setCam && !setCam.value) setCam.value = data.camera_ip;
                    }
                    
                    // Êõ¥Êñ∞ AI ÁãÄÊÖã
                    const aiStatus = document.getElementById('ai-status');
                    if(data.ai_status) {
                        aiStatus.innerText = "AI: ACTIVE";
                        aiStatus.className = "text-green-400 font-bold animate-pulse";
                        document.getElementById('ai-toggle-btn').innerText = "DEACTIVATE AI";
                    } else {
                        aiStatus.innerText = "AI: STANDBY";
                        aiStatus.className = "text-gray-500";
                        document.getElementById('ai-toggle-btn').innerText = "ACTIVATE AI HUD";
                    }

                    // Logs
                    if(data.logs) {
                        const serialized = JSON.stringify(data.logs);
                        if (serialized !== JSON.stringify(lastLogs)) {
                            lastLogs = data.logs.slice();
                            const box = document.getElementById('log-box');
                            box.innerHTML = "";
                            data.logs.forEach(l => {
                                const d = document.createElement('div');
                                d.innerText = l;
                                box.appendChild(d);
                            });
                            box.scrollTop = box.scrollHeight;
                        }
                    }

                } catch (err) { /* ignore */ }
            }, 1000);
        }

        function applySettings() {
            const carIp = document.getElementById('settings-car-ip').value;
            const camIp = document.getElementById('settings-cam-ip').value;
            
            // ÂàÜÂà•ÁôºÈÄÅË®≠ÂÆö
            if(carIp) {
                fetch('/api/set_ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ car_ip: carIp })
                });
            }
            if(camIp) {
                fetch('/api/set_ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cam_ip: camIp })
                });
            }
            log(`Settings applied. CAR:${carIp}, CAM:${camIp}`);
            switchView('main');
        }

        // === Animation & Visuals ===
        function animationLoop(timestamp) {
            const dt = timestamp - lastFrameTime;
            lastFrameTime = timestamp;
            drawRadar(document.getElementById('radar-canvas-main'), timestamp);
            
            // Gamepad heartbeat check
            if(Date.now() - lastXboxUpdate > 2000) {
                const icon = document.getElementById('gamepad-status');
                if(icon) icon.style.opacity = '0.3';
            }
            
            requestAnimationFrame(animationLoop);
        }

        function drawRadar(canvas, time) {
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const cx = w/2, cy = h/2, radius = Math.min(w,h)/2 - 2;
            
            ctx.clearRect(0,0,w,h);
            
            // Grid
            ctx.strokeStyle = 'rgba(0, 255, 157, 0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(cx, cy, radius*0.5, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx, cy-radius); ctx.lineTo(cx, cy+radius); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx-radius, cy); ctx.lineTo(cx+radius, cy); ctx.stroke();

            // Sweep
            radarAngle = (time / 2000 * Math.PI * 2) % (Math.PI * 2);
            const grad = ctx.createConicGradient(radarAngle - Math.PI/2, cx, cy);
            grad.addColorStop(0, 'rgba(0, 255, 157, 0)');
            grad.addColorStop(0.8, 'rgba(0, 255, 157, 0.1)');
            grad.addColorStop(1, 'rgba(0, 255, 157, 0.4)');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI*2); ctx.fill();
        }

        function sendCmd(cmd) {
            highlightKey(cmd);
            fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cmd: cmd })
            }).catch(e => {});
        }

        function highlightKey(cmd) {
            const map = {'F':'btn-w', 'L':'btn-a', 'S':'btn-s', 'R':'btn-d', 'B':'btn-x'};
            const id = map[cmd];
            if(id) {
                const btn = document.getElementById(id);
                btn.classList.add('btn-active');
                setTimeout(() => btn.classList.remove('btn-active'), 150);
            }
        }

        function updateXboxVisual(x, y, pressed) {
            const stick = document.getElementById('xbox-stick');
            if(!stick) return;
            const clamp = (v) => Math.max(-1, Math.min(1, v));
            const offset = 12;
            const dx = clamp(x) * offset;
            const dy = -clamp(y) * offset;
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            if(pressed) stick.style.boxShadow = "0 0 15px #fff";
            else stick.style.boxShadow = "inset 0 0 12px rgba(0,255,157,0.35)";
        }

        let lightState = false;
        function toggleLight() {
            lightState = !lightState;
            sendCmd(lightState ? 'W' : 'w');
        }

        function toggleAI() {
            fetch('/api/toggle_ai', { method: 'POST' });
        }

        function exportLogs() {
            const logs = document.getElementById('log-box').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'system_logs.txt'; a.click();
        }

        async function showNetInfo() {
            try {
                const res = await fetch('/netinfo');
                const data = await res.json();
                let msg = "=== NETWORK INTERFACES ===\n\n";

                if(data.camera_net) {
                    msg += `[CAMERA NET] (ESP32)\nName: ${data.camera_net.name}\nIP: ${data.camera_net.ip}\nMAC: ${data.camera_net.mac}\n\n`;
                } else {
                    msg += `[CAMERA NET] Not Detected\n\n`;
                }

                if(data.internet_net) {
                    msg += `[INTERNET/CAR NET]\nName: ${data.internet_net.name}\nIP: ${data.internet_net.ip}\nMAC: ${data.internet_net.mac}\n\n`;
                } else {
                    msg += `[INTERNET/CAR NET] Not Detected\n\n`;
                }

                msg += "--- Other Interfaces ---\n";
                data.all_ifaces.forEach(iface => {
                    if ((!data.camera_net || iface.name !== data.camera_net.name) &&
                        (!data.internet_net || iface.name !== data.internet_net.name)) {
                        msg += `${iface.name}: ${iface.ip}\n`;
                    }
                });

                alert(msg);
                log("Network Info retrieved.");
            } catch(e) {
                alert("Failed to fetch network info");
            }
        }

        function switchView(view) {
            currentView = view;
            document.getElementById('main-view').style.display = view === 'main' ? 'grid' : 'none';
            document.getElementById('settings-view').style.display = view === 'settings' ? 'block' : 'none';
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav-' + view).classList.add('active');
        }
        
        function log(msg) {
            const box = document.getElementById('log-box');
            if(box) {
                const time = new Date().toLocaleTimeString('en-GB');
                const d = document.createElement('div');
                d.innerHTML = `<span class="text-gray-600">[${time}]</span> ${msg}`;
                box.appendChild(d);
                box.scrollTop = box.scrollHeight;
            }
        }

        // Keyboard
        document.addEventListener('keydown', (e) => {
            if(e.repeat) return;
            const k = e.key.toUpperCase();
            const map = {
                'W':'F', 'A':'L', 'S':'S', 'D':'R', 'X':'B', ' ':'S', 
                'Q':'Q', 'E':'E', 'Z':'Z', 'C':'C' 
            };
            if(map[k]) sendCmd(map[k]);
        });
        document.addEventListener('keyup', (e) => {
            if(['W','A','D','X','Q','E','Z','C'].includes(e.key.toUpperCase())) sendCmd('S');
        });

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);
    </script>
</body>
</html>